<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyx Property Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .logo {
            color: #667eea;
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .dashboard-section {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #333;
        }
        
        .quick-dashboard {
            display: none;
            margin-bottom: 20px;
        }
        
        .compact-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .compact-metric {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .compact-metric:hover {
            transform: translateY(-2px);
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: #007bff;
            color: white;
        }
        
        .nav-tab:hover {
            background: #0056b3;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .property-card {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <div class="login-container">
            <div class="logo">ğŸ </div>
            <h1>Nyx Property Management</h1>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="sn_apt_management@outlook.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <div style="margin-bottom: 15px;">
                <button type="button" onclick="fillAdminCredentials()" style="background: #007bff; color: white; padding: 8px 12px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">Fill Admin</button>
                <button type="button" onclick="fillNinaCredentials()" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">Fill Nina</button>
            </div>
            <button class="btn" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Quick Dashboard -->
    <div id="quickDashboard" class="quick-dashboard">
        <div class="compact-metrics">
            <div class="compact-metric occupancy" onclick="showTab('reports')">
                <div>ğŸ“Š <strong>Occupancy Rate</strong></div>
                <div style="font-size: 24px; color: #28a745;">96%</div>
                <div style="font-size: 12px; color: #6c757d;">Target: 90%</div>
            </div>
            <div class="compact-metric revenue" onclick="showTab('financial')">
                <div>ğŸ’° <strong>Monthly Revenue</strong></div>
                <div style="font-size: 24px; color: #007bff;">R58,145</div>
                <div style="font-size: 12px; color: #6c757d;">Goal: R60,000</div>
            </div>
            <div class="compact-metric checkins" onclick="showTab('checkin')">
                <div>âœ… <strong>Today</strong></div>
                <div style="font-size: 24px; color: #17a2b8;">3 Check-ins | 2 Check-outs</div>
                <div style="font-size: 12px; color: #6c757d;">Next: 2pm arrival</div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardSection" class="dashboard-section">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <span>ğŸ </span>
                <h2>Property Management Dashboard</h2>
                <span>ğŸ‘‹ Welcome, Nicole!</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('properties')">ğŸ  Properties</button>
            <button class="nav-tab" onclick="showTab('bookings')">ğŸ“… Bookings</button>
            <button class="nav-tab" onclick="showTab('checkin')">âœ… Check-in</button>
            <button class="nav-tab" onclick="showTab('domestic')">ğŸ§¹ Domestic</button>
            <button class="nav-tab" onclick="showTab('finance')">ğŸ’° Finance</button>
            <button class="nav-tab" onclick="showTab('tasks')">ğŸ“‹ Tasks</button>
            <button class="nav-tab" onclick="showTab('contacts')">ğŸ“ Contacts</button>
            <button class="nav-tab" onclick="showTab('knowledge')">ğŸ“š Knowledge Base</button>
            <button class="nav-tab" onclick="showTab('reports')">ğŸ“Š Reports</button>
        </div>

        <!-- Properties Tab -->
        <div id="properties-tab" class="tab-content active">
            <h2>ğŸ  Property Overview</h2>
            
            <!-- Speranta Property -->
            <div class="property-card" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; align-items: start;">
                <div style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ </div>
                    <div style="font-size: 14px; font-weight: bold;">Speranta Property Photo</div>
                    <div style="font-size: 12px; margin-top: 5px;">35 Athens Road, Blouberg</div>
                </div>
                <div>
                    <h3 style="color: #28a745; display: flex; align-items: center; gap: 10px;">
                        ğŸŒŸ Speranta Property 
                        <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">ğŸŸ¢ ACTIVE & LISTED</span>
                    </h3>
                    <div style="margin-bottom: 15px;">
                        <p><strong>ğŸ“ Address:</strong> 35 Athens Road, Blouberg</p>
                        <p><strong>ğŸ  Type:</strong> 2BR Apartment | Max 4 Guests</p>
                        <p><strong>ğŸ“¶ WiFi:</strong> SperantaGuest2024</p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="margin: 0 0 10px 0; color: #28a745;">ğŸ”‘ Access Codes & Information</h4>
                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #28a745; margin: 0 0 8px 0;">ï¿½ Pedestrian Gate Codes:</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                                <div>
                                    <strong>7481</strong> - Nicole (Property Manager)
                                </div>
                                <div>
                                    <strong>9147</strong> - Domestic Staff
                                </div>
                                <div>
                                    <strong>5164</strong> - Maintenance Workers
                                </div>
                                <div>
                                    <strong>1242</strong> - Nina & Guests
                                </div>
                            </div>
                        </div>
                        <p style="color: #666; font-size: 12px; margin: 0;">
                            â„¹ï¸ <em>All pedestrian gate codes for 35 Athens Road complex access</em>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- TV House Property -->
            <div class="property-card" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; align-items: start; margin-top: 25px;">
                <div style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¡</div>
                    <div style="font-size: 14px; font-weight: bold;">TV House Property Photo</div>
                    <div style="font-size: 12px; margin-top: 5px;">110 Athens Road, Tableview</div>
                </div>
                <div>
                    <h3 style="color: #6f42c1; display: flex; align-items: center; gap: 10px;">
                        ğŸ¡ TV House Property 
                        <span style="background: #6f42c1; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">ğŸŸ¢ ACTIVE & LISTED</span>
                    </h3>
                    <div style="margin-bottom: 15px;">
                        <p><strong>ğŸ“ Address:</strong> 110 Athens Road, Tableview</p>
                        <p><strong>ğŸ  Type:</strong> 3BR House | Max 6 Guests</p>
                        <p><strong>ğŸ“¶ WiFi:</strong> TVHouseGuest2024</p>
                    </div>
                    
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #6f42c1;">
                        <h4 style="margin: 0 0 10px 0; color: #6f42c1;">ğŸ”‘ Access Codes & Information</h4>
                        <p><strong>ğŸ“¦ Keybox Code:</strong> 2847</p>
                        <p style="color: #666; font-size: 12px; margin: 0;">
                            â„¹ï¸ <em>Updated: This is the keybox code, not a gate code</em>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Status Legend -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 25px;">
                <h4 style="margin: 0 0 10px 0;">ğŸ“Š Status Indicators</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ğŸŸ¢ ACTIVE & LISTED</span>
                        <span style="font-size: 12px; color: #666;">Property is live on all booking platforms</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: #ffc107; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ğŸŸ¡ MAINTENANCE</span>
                        <span style="font-size: 12px; color: #666;">Temporarily offline for repairs</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ğŸ”´ INACTIVE</span>
                        <span style="font-size: 12px; color: #666;">Not currently listed for bookings</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div id="bookings-tab" class="tab-content">
            <h2>ğŸ“… Real Booking Data Integration</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>ğŸ”§ Enhanced Debugging System</h3>
                <p>âœ… Base64 iCal decoding implemented</p>
                <p>âœ… CORS proxy fix applied (/get endpoint)</p>
                <p>âœ… Comprehensive logging with emoji indicators</p>
                <p>âœ… Production-ready code committed</p>
                <button onclick="fetchRealBookingData()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px;">ğŸ”„ Load Real Booking Data</button>
                <button onclick="runDiagnosticCheck()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px; margin-left: 10px;">ğŸ” Diagnostic Check</button>
                <div id="booking-status" style="margin-top: 10px; font-weight: bold;">Ready to load real data</div>
                <div id="api-status" style="margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 14px; background: #f0f8ff; border: 1px solid #007bff; display: none;">
                    <strong>ğŸ”— Booking.com API Integration:</strong> <span id="api-status-text">Initializing...</span>
                </div>
                <div id="diagnostic-results" style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; display: none;">
                    <h5>ğŸ” Diagnostic Results</h5>
                    <div id="diagnostic-content"></div>
                </div>
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4>ğŸ“¡ iCal Feed Integration Status</h4>
                <p>ğŸŸ¢ <strong>Speranta:</strong> 4 platforms configured</p>
                <p>ğŸŸ¢ <strong>TV House:</strong> 3 platforms configured</p>
                <p>ğŸ“ Real booking data will replace test data automatically</p>
            </div>

            <!-- Real Bookings Display -->
            <div id="bookings-display" style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <h3>ğŸ“… Current Bookings</h3>
                <div id="bookings-list" style="margin-top: 15px;">
                    <p style="color: #6c757d; font-style: italic;">Load real booking data to see current reservations...</p>
                </div>
            </div>
        </div>

        <!-- Contacts Tab -->
        <div id="contacts-tab" class="tab-content">
            <h2>ğŸ“ Contacts Management</h2>
            
            <!-- Domestic Services -->
            <div class="property-card">
                <h3>ğŸ§¹ Domestic Services</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    
                    <!-- Spiwe Gwingwizha -->
                    <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #28a745; margin: 0;">ğŸ‘© Spiwe Gwingwizha</h4>
                            <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">DOMESTIC</span>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #28a745;">ğŸ¢ Business Area:</strong> Speranta Property Specialist
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #28a745;">ğŸ“± Contact:</strong> 084 915 0894
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #28a745;">ğŸ’³ Payment Method:</strong> eWallet
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #28a745;">ğŸ  Properties Served:</strong> Speranta (Primary)
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ğŸ“ Call Spiwe
                            </button>
                            <button style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                âœï¸ Edit Details
                            </button>
                        </div>
                    </div>
                    
                    <!-- Patricia Mutizwa -->
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #856404; margin: 0;">ğŸ‘© Patricia Mutizwa</h4>
                            <span style="background: #ffc107; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">DOMESTIC</span>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #856404;">ğŸ¢ Business Area:</strong> Multi-Property Cleaning
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #856404;">ğŸ“± Contact:</strong> 063 735 3892
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #856404;">ğŸ’³ Payment Method:</strong> Bank Transfer
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #856404;">ğŸ  Properties Served:</strong> TV House & Speranta
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button style="background: #ffc107; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ğŸ“ Call Patricia
                            </button>
                            <button style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                âœï¸ Edit Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Team Members -->
            <div class="property-card">
                <h3>ğŸ‘¥ Team Members</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    
                    <!-- Nicole -->
                    <div style="background: #f8f9fa; border: 1px solid #6f42c1; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #6f42c1; margin: 0;">ğŸ‘©â€ğŸ’¼ Nicole Babczyk</h4>
                            <span style="background: #6f42c1; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">MANAGER</span>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #6f42c1;">ğŸ¢ Business Area:</strong> Property Management
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #6f42c1;">ğŸ“± Contact:</strong> [To be added]
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #6f42c1;">ğŸ”‘ Access Codes:</strong> 7481 (Speranta Gate)
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #6f42c1;">ğŸ“§ Email:</strong> [To be added]
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button style="background: #6f42c1; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ğŸ“ Call Nicole
                            </button>
                            <button style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                âœï¸ Edit Details
                            </button>
                        </div>
                    </div>
                    
                    <!-- Nina -->
                    <div style="background: #e3f2fd; border: 1px solid #007bff; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #007bff; margin: 0;">ğŸ‘© Nina</h4>
                            <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">TEAM</span>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #007bff;">ğŸ¢ Business Area:</strong> Guest Coordination
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #007bff;">ğŸ“± Contact:</strong> [To be added]
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #007bff;">ğŸ”‘ Access Codes:</strong> 1242 (Speranta Gate & Guests)
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #007bff;">ğŸ“§ Email:</strong> [To be added]
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ğŸ“ Call Nina
                            </button>
                            <button style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                âœï¸ Edit Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Emergency & Service Contacts -->
            <div class="property-card">
                <h3>ğŸš¨ Emergency & Service Contacts</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <p style="color: #666; margin-bottom: 15px;">Essential service contacts for property management and emergencies.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545;">
                            <h5 style="color: #dc3545; margin: 0 0 8px 0;">ğŸš¨ Emergency Services</h5>
                            <div style="font-size: 14px; color: #666;">
                                <div><strong>Police:</strong> 10111</div>
                                <div><strong>Fire/Ambulance:</strong> 112</div>
                                <div><strong>Local Police:</strong> [To be added]</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                            <h5 style="color: #28a745; margin: 0 0 8px 0;">ğŸ”§ Maintenance</h5>
                            <div style="font-size: 14px; color: #666;">
                                <div><strong>Plumber:</strong> [To be added]</div>
                                <div><strong>Electrician:</strong> [To be added]</div>
                                <div><strong>Handyman:</strong> [To be added]</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
                            <h5 style="color: #007bff; margin: 0 0 8px 0;">ğŸ¢ Property Services</h5>
                            <div style="font-size: 14px; color: #666;">
                                <div><strong>Security Company:</strong> [To be added]</div>
                                <div><strong>Building Management:</strong> [To be added]</div>
                                <div><strong>WiFi Support:</strong> [To be added]</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add New Contact -->
            <div style="background: #e9ecef; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h4 style="color: #495057; margin: 0 0 15px 0;">â• Add New Contact</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <input type="text" placeholder="Full Name" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="text" placeholder="Business/Area" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="text" placeholder="Phone Number" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <select style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option>Select Category</option>
                        <option>Domestic Services</option>
                        <option>Team Member</option>
                        <option>Emergency Contact</option>
                        <option>Service Provider</option>
                        <option>Guest Contact</option>
                    </select>
                    <button style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        ğŸ’¾ Add Contact
                    </button>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ§  Knowledge Base & Guest Information</h2>
                <button class="btn" onclick="openAddArticleModal()" style="width: auto; padding: 8px 16px;">+ Add Article</button>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <input type="text" placeholder="Search articles..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <select style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option>All Categories</option>
                    <option>Property Info</option>
                    <option>Guest Instructions</option>
                    <option>Emergency Procedures</option>
                    <option>Local Area</option>
                    <option>Troubleshooting</option>
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
                <!-- Categories Sidebar -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; height: fit-content;">
                    <h3 style="margin-bottom: 15px;">Categories</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('property')">ğŸ  Property Information</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('guest')">ğŸ‘¥ Guest Instructions</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('emergency')">ğŸš¨ Emergency Procedures</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('local')">ğŸ“ Local Area Guide</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('troubleshoot')">ğŸ”§ Troubleshooting</li>
                    </ul>
                </div>
                
                <!-- Articles Content -->
                <div style="display: grid; gap: 15px;">
                    <div class="article-card" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin-bottom: 5px;">ğŸ“¶ WiFi & Internet Access</h4>
                                <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Property Info</span>
                            </div>
                            <button onclick="editArticle(1)" style="background: none; border: none; cursor: pointer; font-size: 16px;">âœï¸</button>
                        </div>
                        <div style="line-height: 1.6;">
                            <p><strong>Speranta WiFi:</strong></p>
                            <p>â€¢ Network: SperantaGuest2024</p>
                            <p>â€¢ Password: SperantaGuest2024</p>
                            <p><strong>TV House WiFi:</strong></p>
                            <p>â€¢ Network: TVHouseGuest2024</p>
                            <p>â€¢ Password: TVHouseGuest2024</p>
                            <p><strong>If having connection issues:</strong></p>
                            <p>1. Restart your device's WiFi</p>
                            <p>2. Router reset button is in kitchen cabinet</p>
                            <p>3. Contact Nina: +27 123 456 789</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check-in Tab -->
        <div id="checkin-tab" class="tab-content">
            <h2>âœ… Check-in Management</h2>
            
            <!-- Current Active Bookings Management -->
            <div class="property-card">
                <h3>ğŸ  Active Booking Management</h3>
                <p>Manage guest contact, check-in preferences, and domestic service coordination for current bookings.</p>
                
                <!-- TV House Airbnb Booking -->
                <div style="background: #fff8e1; border: 1px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #f57c00; margin: 0;">ğŸ¡ TV House - Airbnb Booking</h4>
                        <span style="background: #FF1493; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">AIRBNB</span>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h5 style="margin: 0 0 12px 0; color: #f57c00;">Guest Information & Contact</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #f57c00;">ğŸ‘¤ Guest Full Name:</label>
                                <input type="text" placeholder="Enter guest full name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="Reserved (Name needed)">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #f57c00;">ğŸ“ Contact Number:</label>
                                <input type="text" placeholder="+27 XXX XXX XXXX" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #f57c00;">ğŸ• Preferred Check-in Time:</label>
                                <input type="time" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="15:00">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #f57c00;">ğŸ• Preferred Check-out Time:</label>
                                <input type="time" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="11:00">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>Guest Contacted</strong> - Initial contact made and information confirmed
                            </label>
                        </div>
                        
                        <div style="border-top: 1px solid #eee; padding-top: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: #f57c00;">ğŸ§¹ Domestic Service Coordination</h6>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #f57c00;">Select Domestic:</label>
                                    <select style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Select Domestic --</option>
                                        <option value="spiwe">Spiwe Gwingwizha - Speranta Specialist (eWallet)</option>
                                        <option value="patricia">Patricia Mutizwa - Both Properties (Bank Transfer)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #f57c00;">Booking Date:</label>
                                    <input type="date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="2025-10-19">
                                </div>
                            </div>
                            
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>Domestic Booked</strong> - Cleaning service confirmed and scheduled
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                ğŸ’¾ Save Changes
                            </button>
                            <button style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                ğŸ“ Contact Guest
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Speranta LekkeSlaap Booking -->
                <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #28a745; margin: 0;">ğŸŒŸ Speranta - LekkeSlaap Booking</h4>
                        <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">LEKKESLAAP</span>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h5 style="margin: 0 0 12px 0; color: #28a745;">Guest Information & Contact</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #28a745;">ğŸ‘¤ Guest Full Name:</label>
                                <input type="text" placeholder="Enter guest full name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="LS-5FZ37J (Name needed)">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #28a745;">ğŸ“ Contact Number:</label>
                                <input type="text" placeholder="+27 XXX XXX XXXX" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #28a745;">ğŸ• Preferred Check-in Time:</label>
                                <input type="time" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="15:00">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #28a745;">ğŸ• Preferred Check-out Time:</label>
                                <input type="time" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="10:00">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>Guest Contacted</strong> - Initial contact made and information confirmed
                            </label>
                        </div>
                        
                        <div style="border-top: 1px solid #eee; padding-top: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: #28a745;">ğŸ§¹ Domestic Service Coordination</h6>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #28a745;">Select Domestic:</label>
                                    <select style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Select Domestic --</option>
                                        <option value="spiwe" selected>Spiwe Gwingwizha - Speranta Specialist (eWallet)</option>
                                        <option value="patricia">Patricia Mutizwa - Both Properties (Bank Transfer)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #28a745;">Booking Date:</label>
                                    <input type="date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="2025-10-20">
                                </div>
                            </div>
                            
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>Domestic Booked</strong> - Cleaning service confirmed and scheduled
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                ğŸ’¾ Save Changes
                            </button>
                            <button style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                ğŸ“ Contact Guest
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Upcoming Bookings Summary -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 25px;">
                    <h4>ğŸ“… Upcoming Check-ins (Next 7 Days)</h4>
                    <p style="color: #666;">No upcoming check-ins scheduled for the next 7 days.</p>
                    <button style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ğŸ”„ Refresh Bookings</button>
                </div>
            </div>
        </div>

        <!-- Domestic Tab -->
        <div id="domestic-tab" class="tab-content">
            <h2>ğŸ§¹ Domestic Services Management</h2>
            
            <!-- Domestic Workers Overview -->
            <div class="property-card">
                <h3>ğŸ‘¥ Domestic Workers Overview</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    
                    <!-- Spiwe Statistics -->
                    <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 20px;">
                        <h4 style="color: #28a745; margin: 0 0 15px 0;">ğŸ‘© Spiwe Gwingwizha</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">0</div>
                                <div style="font-size: 12px; color: #666;">This Month</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">R 0</div>
                                <div style="font-size: 12px; color: #666;">Earnings</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 12px; color: #666;">
                            <strong>Payment:</strong> eWallet | <strong>Properties:</strong> Speranta
                        </div>
                    </div>
                    
                    <!-- Patricia Statistics -->
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px;">
                        <h4 style="color: #856404; margin: 0 0 15px 0;">ğŸ‘© Patricia Mutizwa</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #856404;">0</div>
                                <div style="font-size: 12px; color: #666;">This Month</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #856404;">R 0</div>
                                <div style="font-size: 12px; color: #666;">Earnings</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 12px; color: #666;">
                            <strong>Payment:</strong> Bank Transfer | <strong>Properties:</strong> Both
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calendar & Schedule -->
            <div class="property-card">
                <h3>ğŸ“… Cleaning Schedule Calendar</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0;">October 2025</h4>
                        <div style="display: flex; gap: 10px;">
                            <button style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">â† Prev</button>
                            <button style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Next â†’</button>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 20px;">
                        <!-- Calendar Headers -->
                        <div style="background: #007bff; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px;">Mon</div>
                        <div style="background: #007bff; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px;">Tue</div>
                        <div style="background: #007bff; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px;">Wed</div>
                        <div style="background: #007bff; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px;">Thu</div>
                        <div style="background: #007bff; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px;">Fri</div>
                        <div style="background: #007bff; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px;">Sat</div>
                        <div style="background: #007bff; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px;">Sun</div>
                        
                        <!-- Sample Calendar Days -->
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        
                        <!-- More calendar rows would go here -->
                        <!-- Week 2 -->
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        
                        <!-- Week 3 -->
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: #d4edda; border: 1px solid #28a745; padding: 8px; min-height: 60px; font-size: 12px;">
                            <div style="font-weight: bold;">17</div>
                            <div style="color: #28a745; font-size: 10px;">Today</div>
                        </div>
                        <div style="background: white; border: 1px solid #ddd; padding: 8px; min-height: 60px; font-size: 12px;"></div>
                        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 8px; min-height: 60px; font-size: 12px;">
                            <div style="font-weight: bold;">19</div>
                            <div style="color: #856404; font-size: 10px;">Patricia</div>
                            <div style="color: #856404; font-size: 10px;">TV House</div>
                        </div>
                        <div style="background: #e8f5e8; border: 1px solid #28a745; padding: 8px; min-height: 60px; font-size: 12px;">
                            <div style="font-weight: bold;">20</div>
                            <div style="color: #28a745; font-size: 10px;">Spiwe</div>
                            <div style="color: #28a745; font-size: 10px;">Speranta</div>
                        </div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #e8f5e8; border: 1px solid #28a745;"></div>
                        <span style="font-size: 12px;">Spiwe Bookings</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #fff3cd; border: 1px solid #ffc107;"></div>
                        <span style="font-size: 12px;">Patricia Bookings</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #d4edda; border: 1px solid #28a745;"></div>
                        <span style="font-size: 12px;">Today</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div style="background: #e9ecef; padding: 20px; border-radius: 8px;">
                <h4 style="color: #495057; margin: 0 0 15px 0;">âš¡ Quick Actions</h4>
                <div style="display: flex; gap: 10px;">
                    <button style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        ğŸ“… Schedule Cleaning
                    </button>
                    <button style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        ğŸ“Š View Earnings Report
                    </button>
                    <button style="background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        ğŸ’° Record Payment
                    </button>
                </div>
            </div>
        </div>

        <!-- Finance Tab -->
        <div id="finance-tab" class="tab-content">
            <h2>ğŸ’° Financial Management</h2>
            <div class="property-card">
                <h3>ğŸ’³ Revenue Tracking</h3>
                <p>Financial overview, booking revenue, and expense management.</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #28a745; margin: 0;">Monthly Revenue</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #28a745; margin: 10px 0;">R 0</p>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #856404; margin: 0;">Pending Payments</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #856404; margin: 10px 0;">R 0</p>
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #721c24; margin: 0;">Expenses</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #721c24; margin: 10px 0;">R 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="tab-content">
            <h2>ğŸ“‹ Task Management</h2>
            
            <!-- Active Tasks Section -->
            <div class="property-card">
                <h3>âœ… Active Tasks</h3>
                
                <!-- Pedestrian Gate Code Testing Task -->
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #856404; margin: 0;">ğŸš¶ Pedestrian Gate Code Testing - Speranta Property</h4>
                        <span style="background: #ffc107; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">ASSIGNED TO NINA</span>
                    </div>
                    
                    <p style="color: #856404; margin-bottom: 15px;">
                        <strong>Task:</strong> Test all pedestrian gate codes to ensure they are working properly. Check each code and report any issues.
                    </p>
                    
                    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h5 style="margin: 0 0 12px 0; color: #856404;">Gate Code Testing Checklist:</h5>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>7481</strong> - Nicole (Property Manager) - Gate opens smoothly
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>9147</strong> - Domestic Staff - Gate opens smoothly
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>5164</strong> - Maintenance Workers - Gate opens smoothly
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" style="transform: scale(1.2);"> 
                                <strong>1242</strong> - Nina & Guests - Gate opens smoothly
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #856404;">
                                ğŸ“ Feedback & Issues Report:
                            </label>
                            <textarea 
                                placeholder="Report any issues with gate codes here (e.g., 'Code 9147 not working - gate doesn't respond', 'Code 1242 works but gate is slow to open', etc.)"
                                style="width: 100%; height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px; resize: vertical;"
                            ></textarea>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                âœ… Mark Task Complete
                            </button>
                            <button style="background: #ffc107; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                âš ï¸ Report Issues
                            </button>
                        </div>
                    </div>
                    
                    <div style="font-size: 12px; color: #666;">
                        <strong>Created:</strong> October 17, 2025 | <strong>Priority:</strong> Medium | <strong>Due Date:</strong> October 24, 2025
                    </div>
                </div>
                
                <!-- General Task Management -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4>ğŸ“ General Property Tasks</h4>
                    <ul style="color: #666; margin-bottom: 15px;">
                        <li>No additional active tasks assigned</li>
                    </ul>
                    <button style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">â• Add New Task</button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <h2>ğŸ“Š Reports & Analytics</h2>
            <div class="property-card">
                <h3>ğŸ“ˆ Performance Analytics</h3>
                <p>Booking statistics, occupancy rates, and performance insights.</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <h4>ğŸ“Š Occupancy Rate</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #1976d2;">0%</p>
                        <p style="color: #666; font-size: 12px;">Current month average</p>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <h4>ğŸ“… Total Bookings</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #7b1fa2;" id="total-bookings-count">0</p>
                        <p style="color: #666; font-size: 12px;">This month</p>
                    </div>
                </div>
                
                <!-- Platform Revenue Breakdown -->
                <div style="margin-top: 20px;">
                    <h4>ğŸ’° Revenue Breakdown (Estimated)</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">âš ï¸ Revenue estimates based on average rates. Connect APIs for actual booking values.</p>
                    <div id="revenue-breakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <!-- Revenue cards will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Booking Platform Performance -->
                <div style="margin-top: 20px;">
                    <h4>ğŸ“Š Platform Performance</h4>
                    <div id="platform-performance" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <!-- Platform performance cards will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Sprint Planning & API Feature Roadmap -->
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                    <h4>ğŸš€ Sprint Planning & API Integration Roadmap</h4>
                    <p style="color: #666; margin-bottom: 15px;">Track development features and API integration progress</p>
                    
                    <!-- Current Status -->
                    <div style="background: #d4edda; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                        <h5 style="color: #155724; margin: 0 0 10px 0;">âœ… Current Status (Manual Override Active)</h5>
                        <ul style="color: #155724; margin: 0;">
                            <li><strong>âœ… Manual Guest Contact System:</strong> Fully functional - click "â• Add Contact Info" on any booking</li>
                            <li><strong>âœ… Enhanced Data Display:</strong> Reservation codes and contact info display working</li>
                            <li><strong>âœ… Local Storage:</strong> Guest data persists between sessions</li>
                            <li><strong>âš ï¸ API Integration:</strong> Temporarily disabled due to CORS/timeout issues</li>
                        </ul>
                    </div>
                    
                    <!-- Sprint Backlog -->
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                        <h5 style="color: #856404; margin: 0 0 10px 0;">ğŸ“‹ Sprint Backlog (Future Development)</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 0 0 8px 0; font-weight: bold; color: #856404;">ğŸ”§ Sprint Item #1: Server-Side API Integration</p>
                                <ul style="color: #856404; font-size: 13px; margin: 0;">
                                    <li>Set up Node.js/Express backend server</li>
                                    <li>Implement server-side iCal fetching</li>
                                    <li>Add proper CORS handling</li>
                                    <li>Create API proxy endpoints</li>
                                </ul>
                            </div>
                            <div>
                                <p style="margin: 0 0 8px 0; font-weight: bold; color: #856404;">ğŸ”§ Sprint Item #2: Enhanced Data Extraction</p>
                                <ul style="color: #856404; font-size: 13px; margin: 0;">
                                    <li>Improve Airbnb data parsing</li>
                                    <li>Add Booking.com guest extraction</li>
                                    <li>Implement FeWo-direkt integration</li>
                                    <li>Add data validation & fallbacks</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="alert('ğŸ“ Sprint Item Created:\\n\\nTitle: Server-Side API Integration\\nPriority: Medium\\nEstimated: 2-3 days\\n\\nDescription: Implement backend server to handle iCal API requests and resolve CORS issues for automatic booking data extraction.')" 
                                style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ“ Create Sprint Item
                        </button>
                        <button onclick="showInterimSolution()" 
                                style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ’¡ View Interim Solution
                        </button>
                        <button onclick="exportGuestData()" 
                                style="background: #6f42c1; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ“¤ Export Guest Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load API Integration -->
    <script src="live-api-integration.js"></script>
    <script src="airbnb-api-integration.js"></script>
    <script src="lekkeslaap-api-integration.js"></script>
    <script src="fewo-api-integration.js"></script>
    
    <script>
        // ===========================================
        // ENHANCED DEBUGGING SYSTEM WITH LIVE API
        // ===========================================
        
        const PROPERTY_ICAL_FEEDS = {
            speranta: {
                name: 'Speranta (35 Athens Road Blouberg)',
                feeds: {
                    booking: 'https://ical.booking.com/v1/export?t=8123e217-45b4-403d-8fa0-9dcc65c26800',
                    lekkeslaap: 'https://www.lekkeslaap.co.za/suppliers/icalendar.ics?t=bXEzOHNicTJQT3Nkd1dHb1ZSaXhRUT09',
                    fewo: 'http://www.fewo-direkt.de/icalendar/12b719114ecd42adab4e9ade2d2458e6.ics?nonTentative',
                    airbnb: 'https://www.airbnb.com/calendar/ical/1237076374831130516.ics?s=01582d0497e99114aa6013156146cea4&locale=en-GB'
                }
            },
            tvhouse: {
                name: 'TV House (110 Athens Road Tableview)',
                feeds: {
                    booking: 'https://ical.booking.com/v1/export?t=ea29c451-4d0b-4fa4-b7a8-e879a33a8940',
                    lekkeslaap: 'https://www.lekkeslaap.co.za/suppliers/icalendar.ics?t=QzZ2aFlFVHhxYnoxdGRVL3ZwelRGUT09',
                    airbnb: 'https://www.airbnb.com/calendar/ical/1402174824640448492.ics?s=373c5a71c137230a72f928e88728dcf3&locale=en-GB'
                }
            }
        };

        let globalBookingData = { speranta: [], tvhouse: [], lastUpdated: null };
        let historicalBookingData = []; // Persistent storage for all historical bookings

        // Load historical data from localStorage
        function loadHistoricalData() {
            try {
                const stored = localStorage.getItem('nyxPropertyBookingHistory');
                if (stored) {
                    historicalBookingData = JSON.parse(stored);
                    console.log(`ğŸ“œ Loaded ${historicalBookingData.length} historical bookings from storage`);
                }
            } catch (error) {
                console.error('Error loading historical data:', error);
                historicalBookingData = [];
            }
        }

        // Save booking data to localStorage
        function saveBookingToHistory(booking) {
            // Filter out blocked/closed entries that aren't real bookings
            const isBlockedEntry = booking.summary && (
                booking.summary.toLowerCase().includes('closed') ||
                booking.summary.toLowerCase().includes('blocked') ||
                booking.summary.toLowerCase().includes('not available') ||
                booking.summary.toLowerCase().includes('maintenance') ||
                (booking.platform === 'fewo' && booking.summary.toLowerCase().includes('close'))
            );
            
            if (isBlockedEntry) {
                console.log(`ğŸš« Skipping blocked entry for history: "${booking.summary}" (${booking.platform})`);
                return; // Don't save blocked entries to history
            }
            
            // Create a unique ID for the booking
            const bookingId = `${booking.property}-${booking.platform}-${booking.start}-${booking.end}`;
            
            // Check if booking already exists
            const exists = historicalBookingData.some(stored => 
                stored.id === bookingId || 
                (stored.property === booking.property && 
                 stored.platform === booking.platform && 
                 stored.start === booking.start && 
                 stored.end === booking.end)
            );
            
            if (!exists) {
                const bookingRecord = {
                    ...booking,
                    id: bookingId,
                    savedAt: new Date().toISOString(),
                    status: getBookingStatus(booking)
                };
                
                historicalBookingData.push(bookingRecord);
                
                // Keep only last 500 bookings to prevent localStorage overflow
                if (historicalBookingData.length > 500) {
                    historicalBookingData = historicalBookingData.slice(-500);
                }
                
                // Save to localStorage
                try {
                    localStorage.setItem('nyxPropertyBookingHistory', JSON.stringify(historicalBookingData));
                    console.log(`ğŸ’¾ Saved booking: ${booking.summary} (${booking.property} - ${booking.platform})`);
                } catch (error) {
                    console.error('Error saving booking to history:', error);
                }
            }
        }

        // Determine booking status
        function getBookingStatus(booking) {
            const today = new Date();
            const startDate = new Date(booking.start);
            const endDate = new Date(booking.end);
            
            if (startDate <= today && endDate >= today) {
                return 'current';
            } else if (startDate > today) {
                return 'upcoming';
            } else {
                return 'past';
            }
        }

        // Save all current bookings to history
        function saveAllBookingsToHistory() {
            const allBookings = [
                ...globalBookingData.speranta.map(b => ({...b, property: 'Speranta'})),
                ...globalBookingData.tvhouse.map(b => ({...b, property: 'TV House'}))
            ];
            
            allBookings.forEach(booking => saveBookingToHistory(booking));
            console.log(`ğŸ“¦ Processed ${allBookings.length} bookings for historical storage`);
        }

        // Enhanced iCal Parser with Comprehensive Debugging
        function parseICalData(icalText, platform) {
            console.log(`ğŸ”§ parseICalData called for ${platform}`);
            console.log(`ğŸ“ Input text length: ${icalText.length}`);
            console.log(`ğŸ“„ First 500 chars: ${icalText.substring(0, 500)}`);
            
            const events = [];
            const lines = icalText.split('\n');
            let currentEvent = {};
            let inEvent = false;
            let eventCount = 0;
            let vcalendarFound = false;

            console.log(`ğŸ“‹ Processing ${lines.length} lines`);

            // Check for VCALENDAR structure
            for (let i = 0; i < Math.min(50, lines.length); i++) {
                const line = lines[i].trim();
                if (line === 'BEGIN:VCALENDAR') {
                    vcalendarFound = true;
                    console.log(`ğŸ“… Found VCALENDAR at line ${i + 1}`);
                    break;
                }
            }

            if (!vcalendarFound) {
                console.log(`âš ï¸ No VCALENDAR found in first 50 lines - this might not be a valid iCal file`);
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === 'BEGIN:VEVENT') {
                    console.log(`ğŸ¯ Found BEGIN:VEVENT at line ${i + 1}`);
                    inEvent = true;
                    currentEvent = { platform: platform };
                    eventCount++;
                } else if (line === 'END:VEVENT' && inEvent) {
                    console.log(`ğŸ Found END:VEVENT at line ${i + 1} for event ${eventCount}`);
                    console.log(`ğŸ” Event data:`, currentEvent);
                    
                    // Filter out blocked/closed entries that aren't real bookings
                    const isBlockedEntry = currentEvent.summary && (
                        currentEvent.summary.toLowerCase().includes('closed') ||
                        currentEvent.summary.toLowerCase().includes('blocked') ||
                        currentEvent.summary.toLowerCase().includes('not available') ||
                        currentEvent.summary.toLowerCase().includes('maintenance') ||
                        (platform === 'fewo' && currentEvent.summary.toLowerCase().includes('close'))
                    );
                    
                    if (isBlockedEntry) {
                        console.log(`ğŸš« Filtered out blocked entry: "${currentEvent.summary}" (${platform})`);
                    } else if (currentEvent.start && currentEvent.end) {
                        console.log(`âœ… Valid event: ${currentEvent.summary} from ${currentEvent.start} to ${currentEvent.end}`);
                        events.push(currentEvent);
                    } else {
                        console.log(`âŒ Invalid event (missing dates): start=${currentEvent.start}, end=${currentEvent.end}`);
                        console.log(`ğŸ” Raw event object:`, currentEvent);
                    }
                    currentEvent = {};
                    inEvent = false;
                } else if (inEvent) {
                    if (line.startsWith('DTSTART')) {
                        const fullLine = line;
                        let dateStr = '';
                        if (line.includes(':')) {
                            dateStr = line.split(':').slice(1).join(':');
                        } else if (line.includes('=')) {
                            dateStr = line.split('=').pop();
                        }
                        console.log(`ğŸ“… DTSTART line: "${fullLine}" â†’ extracted: "${dateStr}"`);
                        currentEvent.start = parseICalDate(dateStr);
                        console.log(`ğŸ“… DTSTART parsed: ${dateStr} â†’ ${currentEvent.start}`);
                    } else if (line.startsWith('DTEND')) {
                        const fullLine = line;
                        let dateStr = '';
                        if (line.includes(':')) {
                            dateStr = line.split(':').slice(1).join(':');
                        } else if (line.includes('=')) {
                            dateStr = line.split('=').pop();
                        }
                        console.log(`ğŸ“… DTEND line: "${fullLine}" â†’ extracted: "${dateStr}"`);
                        currentEvent.end = parseICalDate(dateStr);
                        console.log(`ğŸ“… DTEND parsed: ${dateStr} â†’ ${currentEvent.end}`);
                    } else if (line.startsWith('SUMMARY')) {
                        const summary = line.includes(':') ? line.split(':').slice(1).join(':') : 'Booking';
                        currentEvent.summary = summary;
                        console.log(`ğŸ“ SUMMARY: ${summary}`);
                    } else if (line.startsWith('DESCRIPTION')) {
                        const description = line.includes(':') ? line.split(':').slice(1).join(':') : '';
                        currentEvent.description = description;
                        console.log(`ğŸ“„ DESCRIPTION: ${description}`);
                    } else if (line.startsWith('ORGANIZER')) {
                        const organizer = line.includes(':') ? line.split(':').slice(1).join(':') : '';
                        currentEvent.organizer = organizer;
                        console.log(`ğŸ‘¤ ORGANIZER: ${organizer}`);
                    } else if (line.startsWith('ATTENDEE')) {
                        const attendee = line.includes(':') ? line.split(':').slice(1).join(':') : '';
                        if (!currentEvent.attendees) currentEvent.attendees = [];
                        currentEvent.attendees.push(attendee);
                        console.log(`ğŸ‘¥ ATTENDEE: ${attendee}`);
                    }
                }
            }
            
            console.log(`ğŸŠ parseICalData finished: Found ${events.length} valid events out of ${eventCount} VEVENT blocks`);
            console.log(`ğŸ“Š Summary: VCALENDAR=${vcalendarFound}, VEVENT blocks=${eventCount}, Valid events=${events.length}`);
            
            if (eventCount > 0 && events.length === 0) {
                console.log(`âš ï¸ WARNING: Found ${eventCount} VEVENT blocks but 0 valid events - likely date parsing issues`);
            }
            
            return events;
        }

        function parseICalDate(dateString) {
            console.log(`ğŸ•’ Parsing date: "${dateString}"`);
            
            if (dateString.length === 8) {
                const parsed = new Date(
                    dateString.substring(0, 4),
                    dateString.substring(4, 6) - 1,
                    dateString.substring(6, 8)
                );
                console.log(`ğŸ“… Parsed YYYYMMDD format: ${dateString} â†’ ${parsed}`);
                return parsed;
            } else if (dateString.includes('T')) {
                const date = dateString.split('T')[0];
                const parsed = new Date(
                    date.substring(0, 4),
                    date.substring(4, 6) - 1,
                    date.substring(6, 8)
                );
                console.log(`ğŸ“… Parsed datetime format: ${dateString} â†’ ${parsed}`);
                return parsed;
            }
            
            const parsed = new Date(dateString);
            console.log(`ğŸ“… Parsed generic format: ${dateString} â†’ ${parsed}`);
            return parsed;
        }

        // Guest Contact Management System
        let guestContactData = {};
        
        // Load guest contact data from localStorage
        function loadGuestContactData() {
            try {
                const stored = localStorage.getItem('nyxGuestContactData');
                if (stored) {
                    guestContactData = JSON.parse(stored);
                    console.log('ğŸ“ Loaded guest contact data from storage');
                }
            } catch (error) {
                console.error('Error loading guest contact data:', error);
                guestContactData = {};
            }
        }
        
        // Save guest contact data to localStorage
        function saveGuestContactData() {
            try {
                localStorage.setItem('nyxGuestContactData', JSON.stringify(guestContactData));
                console.log('ğŸ’¾ Saved guest contact data to storage');
            } catch (error) {
                console.error('Error saving guest contact data:', error);
            }
        }
        
        // Add guest contact information with enhanced manual override
        function addGuestContact(property, startDate, platform) {
            const bookingKey = `${property}_${startDate}_${platform}`;
            
            // Pre-fill with any existing data
            const existing = guestContactData[bookingKey] || {};
            
            const guestName = prompt('Enter guest full name:', existing.guestName || '');
            if (!guestName) return;
            
            const phone = prompt('Enter guest phone number:', existing.phone || '');
            const email = prompt('Enter guest email:', existing.email || '');
            const reservationCode = prompt('Enter reservation/booking code (if available):', existing.reservationCode || '');
            const guestCount = prompt('Number of guests:', existing.guestCount || '1');
            const checkinTime = prompt('Preferred check-in time (e.g., 3:00 PM):', existing.checkinTime || 'To be confirmed');
            const checkoutTime = prompt('Preferred check-out time (e.g., 11:00 AM):', existing.checkoutTime || '11:00 AM (Standard)');
            const specialRequests = prompt('Special requests or notes:', existing.specialRequests || '');
            
            guestContactData[bookingKey] = {
                guestName,
                phone: phone || 'Not provided',
                email: email || 'Not provided',
                reservationCode: reservationCode || '',
                guestCount: parseInt(guestCount) || 1,
                checkinTime,
                checkoutTime,
                specialRequests,
                addedDate: existing.addedDate || new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                property,
                platform,
                startDate,
                manualOverride: true // Flag to indicate this was manually entered
            };
            
            saveGuestContactData();
            alert(`âœ… Guest contact information ${existing.guestName ? 'updated' : 'saved'} successfully!\n\nğŸ“‹ Sprint Item: API Integration feature can be planned for future development.`);
            
            // Refresh the bookings display
            if (globalBookingData.speranta.length > 0 || globalBookingData.tvhouse.length > 0) {
                displayBookings(globalBookingData);
            }
        }
        
        // View guest details
        function viewGuestDetails(property, startDate, platform) {
            const bookingKey = `${property}_${startDate}_${platform}`;
            const guestInfo = guestContactData[bookingKey];
            
            if (!guestInfo) {
                alert('No contact information available for this guest. Click "Add Contact Info" to add details.');
                return;
            }
            
            const details = `
Guest Details for ${property}:

ğŸ‘¤ Name: ${guestInfo.guestName}
ğŸ“ Phone: ${guestInfo.phone}
ğŸ“§ Email: ${guestInfo.email}
ğŸ‘¥ Guest Count: ${guestInfo.guestCount}
ï¿½ Check-in Time: ${guestInfo.checkinTime || 'Not set'}
ğŸ•š Check-out Time: ${guestInfo.checkoutTime || 'Not set'}
ï¿½ğŸ“ Special Requests: ${guestInfo.specialRequests || 'None'}
ğŸ“… Added: ${new Date(guestInfo.addedDate).toLocaleDateString()}
            `.trim();
            
            alert(details);
        }
        
        // Get guest contact for display
        function getGuestContact(property, startDate, platform, booking = null) {
            const bookingKey = `${property}_${startDate}_${platform}`;
            
            console.log(`ğŸ” getGuestContact called for ${property} ${platform} booking:`, booking);
            
            // Priority 1: Check if booking has enhanced Airbnb data from API integration
            if (booking && booking.apiEnhanced && booking.platform === 'airbnb' && booking.enhancedGuestName) {
                console.log('ğŸ”— Using enhanced Airbnb API data for guest contact');
                
                return {
                    guestName: booking.enhancedGuestName,
                    phone: booking.enhancedPhone,
                    email: booking.enhancedEmail,
                    guestCount: 1,
                    checkinTime: 'To be confirmed',
                    checkoutTime: '11:00 AM (Standard)',
                    specialRequests: booking.enhancedSpecialRequests,
                    source: 'airbnb_api_enhanced',
                    apiEnhanced: true,
                    platform: 'airbnb',
                    property,
                    startDate,
                    reservationCode: booking.enhancedReservationCode
                };
            } else if (booking && booking.platform === 'airbnb') {
                console.log('âŒ Airbnb booking failed Priority 1 check:', {
                    hasBooking: !!booking,
                    apiEnhanced: booking?.apiEnhanced,
                    platform: booking?.platform,
                    enhancedGuestName: booking?.enhancedGuestName,
                    allProps: Object.keys(booking || {})
                });
            }
            
            // Priority 1.5: Check if booking has enhanced LekkeSlaap data from API integration  
            if (booking && booking.apiEnhanced && booking.platform === 'lekkeslaap' && booking.enhancedGuestName) {
                console.log('ğŸ”— Using enhanced LekkeSlaap API data for guest contact');
                
                return {
                    guestName: booking.enhancedGuestName,
                    phone: booking.enhancedPhone,
                    email: booking.enhancedEmail,
                    guestCount: 1,
                    checkinTime: 'To be confirmed',
                    checkoutTime: '11:00 AM (Standard)',
                    specialRequests: booking.enhancedSpecialRequests,
                    source: 'lekkeslaap_api_enhanced',
                    apiEnhanced: true,
                    platform: 'lekkeslaap',
                    property,
                    startDate,
                    referenceCode: booking.enhancedReferenceCode
                };
            }
            
            // Priority 2: Check if booking has API-enhanced data (legacy structure)
            if (booking && booking.enhancedData && booking.enhancedData.apiEnhanced) {
                const apiData = booking.enhancedData;
                console.log(`ğŸ”— Using ${apiData.platform} API data for guest contact`);
                
                return {
                    guestName: apiData.guest?.name || 'API Guest',
                    phone: apiData.guest?.phone || 'Available via platform',
                    email: apiData.guest?.email || 'Available via platform',
                    guestCount: apiData.guestCount || 1,
                    checkinTime: apiData.checkinTime || 'To be confirmed',
                    checkoutTime: apiData.checkoutTime || '11:00 AM (Standard)',
                    specialRequests: apiData.specialRequests || '',
                    source: `${apiData.platform}_api`,
                    apiEnhanced: true,
                    platform: apiData.platform,
                    property,
                    startDate,
                    pricing: apiData.pricing || null
                };
            }
            
            // Priority 3: Check if booking has Booking.com API data
            if (booking && booking.apiEnhanced) {
                console.log('ğŸ”— Using Booking.com API data for guest contact');
                return {
                    guestName: booking.guestName || 'Booking.com Guest',
                    phone: booking.guestPhone || 'Check Booking.com',
                    email: booking.guestEmail || 'Check Booking.com',
                    guestCount: booking.guestCount || 1,
                    checkinTime: booking.checkinTime || 'To be confirmed',
                    checkoutTime: booking.checkoutTime || '11:00 AM (Standard)',
                    specialRequests: booking.specialRequests || '',
                    source: 'booking_com_api',
                    apiEnhanced: true,
                    platform: 'booking.com',
                    property,
                    startDate,
                    pricing: {
                        total: booking.totalAmount,
                        currency: booking.currency
                    }
                };
            }
            
            // Priority 4: Extract Airbnb data from description if available
            if (booking && booking.platform === 'airbnb' && booking.description) {
                console.log('ğŸ”— Extracting Airbnb data from description');
                
                let reservationCode = '';
                let phoneDigits = '';
                
                // Extract reservation code
                const reservationMatch = booking.description.match(/details\/([A-Z0-9]+)/);
                if (reservationMatch) {
                    reservationCode = reservationMatch[1];
                }
                
                // Extract phone digits
                const phoneMatch = booking.description.match(/Phone Number \(Last 4 Digits\):\s*(\d{4})/);
                if (phoneMatch) {
                    phoneDigits = phoneMatch[1];
                }
                
                if (reservationCode || phoneDigits) {
                    return {
                        guestName: reservationCode ? `Airbnb Guest (${reservationCode})` : 'Airbnb Guest',
                        phone: phoneDigits ? `Phone ends in: ${phoneDigits} (Full number via Airbnb)` : 'Available via Airbnb messaging',
                        email: 'Available via Airbnb messaging',
                        guestCount: 1,
                        checkinTime: 'To be confirmed',
                        checkoutTime: '11:00 AM (Standard)',
                        specialRequests: reservationCode ? `Airbnb Reservation: ${reservationCode}` : 'Check Airbnb app for guest requests',
                        source: 'airbnb_description',
                        apiEnhanced: true,
                        platform: 'airbnb',
                        property,
                        startDate,
                        reservationCode: reservationCode
                    };
                }
            }
            
            // Priority 5: Use manually entered data
            const manualData = guestContactData[bookingKey];
            if (manualData) {
                console.log('ğŸ“ Using manually entered guest contact data');
                return {
                    ...manualData,
                    source: 'manual_entry',
                    apiEnhanced: false
                };
            }
            
            // Priority 6: Return null if no data available
            return null;
        }
        
        // Set check-in time
        function setCheckinTime(property, startDate, platform) {
            const bookingKey = `${property}_${startDate}_${platform}`;
            const currentTime = guestContactData[bookingKey]?.checkinTime || '';
            
            const newTime = prompt('Enter preferred check-in time (e.g., 3:00 PM, 15:00):', currentTime);
            if (newTime && newTime.trim() !== '') {
                if (!guestContactData[bookingKey]) {
                    guestContactData[bookingKey] = {
                        guestName: 'Guest',
                        phone: 'Not provided',
                        email: 'Not provided',
                        guestCount: 1,
                        specialRequests: '',
                        addedDate: new Date().toISOString(),
                        property,
                        platform,
                        startDate
                    };
                }
                
                guestContactData[bookingKey].checkinTime = newTime.trim();
                saveGuestContactData();
                
                // Refresh the bookings display
                if (globalBookingData.speranta.length > 0 || globalBookingData.tvhouse.length > 0) {
                    displayBookings(globalBookingData);
                }
            }
        }
        
        // Set check-out time
        function setCheckoutTime(property, startDate, platform) {
            const bookingKey = `${property}_${startDate}_${platform}`;
            const currentTime = guestContactData[bookingKey]?.checkoutTime || '11:00 AM (Standard)';
            
            const newTime = prompt('Enter preferred check-out time (e.g., 11:00 AM, 12:00 PM):', currentTime);
            if (newTime && newTime.trim() !== '') {
                if (!guestContactData[bookingKey]) {
                    guestContactData[bookingKey] = {
                        guestName: 'Guest',
                        phone: 'Not provided',
                        email: 'Not provided',
                        guestCount: 1,
                        specialRequests: '',
                        addedDate: new Date().toISOString(),
                        property,
                        platform,
                        startDate
                    };
                }
                
                guestContactData[bookingKey].checkoutTime = newTime.trim();
                saveGuestContactData();
                
                // Refresh the bookings display
                if (globalBookingData.speranta.length > 0 || globalBookingData.tvhouse.length > 0) {
                    displayBookings(globalBookingData);
                }
            }
        }
        
        // Sprint Planning Helper Functions
        function showInterimSolution() {
            alert('ğŸ’¡ Interim Solution Active:\n\nâœ… Use manual override system\nâœ… Click "Add Contact Info" on bookings\nâœ… Data saves automatically\n\nAPI integration planned for future sprint!');
        }
        
        function exportGuestData() {
            const dataStr = JSON.stringify(guestContactData, null, 2);
            const dataBlob = new Blob([dataStr], {type:'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `guest-contact-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('ğŸ“¤ Guest contact data exported successfully!\n\nFile saved as: guest-contact-data-' + new Date().toISOString().split('T')[0] + '.json');
        }
        
        // Calculate reporting metrics
        function calculateReportingMetrics() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Combine all bookings
            const allBookings = [
                ...globalBookingData.speranta.map(b => ({...b, property: 'Speranta'})),
                ...globalBookingData.tvhouse.map(b => ({...b, property: 'TV House'}))
            ];
            
            // Current month bookings
            const thisMonthBookings = allBookings.filter(booking => {
                const bookingDate = new Date(booking.start);
                return bookingDate.getMonth() === currentMonth && bookingDate.getFullYear() === currentYear;
            });
            
            // Platform breakdown
            const platformStats = {};
            allBookings.forEach(booking => {
                if (!platformStats[booking.platform]) {
                    platformStats[booking.platform] = {
                        count: 0,
                        properties: new Set(),
                        estimatedRevenue: 0
                    };
                }
                platformStats[booking.platform].count++;
                platformStats[booking.platform].properties.add(booking.property);
                
                // Estimated revenue (these would come from API in production)
                const avgRates = {
                    'airbnb': 1200,
                    'booking': 1100,
                    'lekkeslaap': 950,
                    'fewo': 1300
                };
                
                const nights = Math.ceil((new Date(booking.end) - new Date(booking.start)) / (1000 * 60 * 60 * 24));
                platformStats[booking.platform].estimatedRevenue += (avgRates[booking.platform] || 1000) * nights;
            });
            
            // Update total bookings count
            const totalBookingsElement = document.getElementById('total-bookings-count');
            if (totalBookingsElement) {
                totalBookingsElement.textContent = thisMonthBookings.length;
            }
            
            // Update revenue breakdown
            updateRevenueBreakdown(platformStats);
            
            // Update platform performance
            updatePlatformPerformance(platformStats);
            
            // Calculate occupancy rate
            calculateOccupancyRate(allBookings);
        }
        
        // Update revenue breakdown display
        function updateRevenueBreakdown(platformStats) {
            const revenueElement = document.getElementById('revenue-breakdown');
            if (!revenueElement) return;
            
            let html = '';
            const platformColors = {
                'airbnb': '#FF1493',
                'booking': '#007bff',
                'lekkeslaap': '#28a745',
                'fewo': '#ffc107'
            };
            
            Object.entries(platformStats).forEach(([platform, stats]) => {
                const color = platformColors[platform] || '#6c757d';
                html += `
                    <div style="background: linear-gradient(135deg, ${color}20 0%, ${color}10 100%); border: 1px solid ${color}; border-radius: 8px; padding: 15px;">
                        <h5 style="color: ${color}; margin: 0 0 8px 0; text-transform: uppercase; font-size: 14px; font-weight: bold;">${platform}</h5>
                        <p style="font-size: 20px; font-weight: bold; color: #333; margin: 0;">R${stats.estimatedRevenue.toLocaleString()}</p>
                        <p style="color: #666; font-size: 12px; margin: 4px 0 0 0;">${stats.count} bookings</p>
                    </div>
                `;
            });
            
            revenueElement.innerHTML = html;
        }
        
        // Update platform performance display  
        function updatePlatformPerformance(platformStats) {
            const performanceElement = document.getElementById('platform-performance');
            if (!performanceElement) return;
            
            let html = '';
            const total = Object.values(platformStats).reduce((sum, stats) => sum + stats.count, 0);
            
            Object.entries(platformStats).forEach(([platform, stats]) => {
                const percentage = total > 0 ? ((stats.count / total) * 100).toFixed(1) : 0;
                const color = {
                    'airbnb': '#FF1493',
                    'booking': '#007bff', 
                    'lekkeslaap': '#28a745',
                    'fewo': '#ffc107'
                }[platform] || '#6c757d';
                
                html += `
                    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">${platform.toUpperCase()}</span>
                            <span style="font-weight: bold;">${percentage}% of bookings</span>
                        </div>
                        <div style="color: #666; font-size: 14px; line-height: 1.4;">
                            <div>ğŸ“Š ${stats.count} total bookings</div>
                            <div>ğŸ  ${stats.properties.size} propert${stats.properties.size !== 1 ? 'ies' : 'y'}</div>
                            <div>ğŸ’° R${stats.estimatedRevenue.toLocaleString()} estimated</div>
                        </div>
                    </div>
                `;
            });
            
            performanceElement.innerHTML = html;
        }
        
        // Update API status display with all platform statuses
        function updateAPIStatus(message, color) {
            const apiStatusElement = document.getElementById('api-status');
            const apiStatusText = document.getElementById('api-status-text');
            
            if (apiStatusElement && apiStatusText) {
                apiStatusElement.style.display = 'block';
                apiStatusElement.style.borderColor = color;
                apiStatusText.textContent = message;
                apiStatusText.style.color = color;
                console.log('ğŸ“¡ API Status:', message);
            }
        }
        
        // Update comprehensive API status for all platforms
        function updateComprehensiveAPIStatus() {
            const platforms = [];
            
            console.log('ğŸ” Checking platform statuses...');
            
            // Check Booking.com status
            if (window.enhancedHostEasePro?.isAPIEnabled) {
                platforms.push('âœ… Booking.com (Connected)');
                console.log('âœ… Booking.com: Connected');
            } else {
                platforms.push('âš ï¸ Booking.com (iCal only)');
                console.log('âš ï¸ Booking.com: iCal only');
            }
            
            // Check Airbnb status
            if (window.airbnbAPI?.isInitialized) {
                platforms.push('âœ… Airbnb (Enhanced)');
                console.log('âœ… Airbnb: Enhanced');
            } else {
                platforms.push('âš ï¸ Airbnb (Partner API required)');
                console.log('âš ï¸ Airbnb: Partner API required');
            }
            
            // Check LekkeSlaap status
            if (window.lekkeSlaapAPI?.isInitialized) {
                platforms.push('âœ… LekkeSlaap (Enhanced)');
                console.log('âœ… LekkeSlaap: Enhanced');
            } else {
                platforms.push('âš ï¸ LekkeSlaap (API access required)');
                console.log('âš ï¸ LekkeSlaap: API access required');
            }
            
            // Check FeWo status
            if (window.fewoAPI?.isInitialized) {
                platforms.push('âœ… FeWo (Enhanced)');
                console.log('âœ… FeWo: Enhanced');
            } else {
                platforms.push('âš ï¸ FeWo (API access required)');
                console.log('âš ï¸ FeWo: API access required');
            }
            
            const statusMessage = `Multi-Platform Status: ${platforms.join(' | ')}`;
            const hasFullAPI = platforms.some(p => p.includes('Connected'));
            const color = hasFullAPI ? '#28a745' : '#ffc107';
            
            console.log('ğŸ“Š Final status message:', statusMessage);
            updateAPIStatus(statusMessage, color);
        }

        // Calculate occupancy rate
        function calculateOccupancyRate(allBookings) {
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const totalPropertyDays = daysInMonth * 2; // 2 properties
            
            let bookedDays = 0;
            allBookings.forEach(booking => {
                const start = new Date(booking.start);
                const end = new Date(booking.end);
                
                // Only count days in current month
                if (start.getMonth() === today.getMonth() && start.getFullYear() === today.getFullYear()) {
                    const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                    bookedDays += nights;
                }
            });
            
            const occupancyRate = Math.min(100, ((bookedDays / totalPropertyDays) * 100));
            
            // Update occupancy display
            const occupancyElements = document.querySelectorAll('p');
            occupancyElements.forEach(el => {
                if (el.textContent === '0%' && el.style.color === 'rgb(25, 118, 210)') {
                    el.textContent = `${occupancyRate.toFixed(1)}%`;
                }
            });
        }

        // Enhanced Data Fetching with Live API Integration
        async function fetchRealBookingData() {
            console.log('ğŸ”¥ FETCHING REAL BOOKING DATA WITH MULTI-PLATFORM API INTEGRATION...');
            console.log('ğŸš¨ DEBUG: fetchRealBookingData() function started');
            
            // Initialize all API integrations
            updateAPIStatus('Initializing API integrations...', '#ffc107');
            
            // Initialize Booking.com API
            if (window.enhancedHostEasePro) {
                console.log('ğŸš€ Initializing Booking.com API integration...');
                await window.enhancedHostEasePro.initializeAPI();
                
                if (window.enhancedHostEasePro.isAPIEnabled) {
                    console.log('âœ… Booking.com API connected');
                } else {
                    console.log('âš ï¸ Booking.com API connection failed');
                }
            }
            
            // Initialize Airbnb API
            console.log('ğŸš¨ DEBUG: About to check window.AirbnbAPIIntegration');
            console.log('ğŸš¨ DEBUG: window.AirbnbAPIIntegration =', typeof window.AirbnbAPIIntegration);
            if (window.AirbnbAPIIntegration) {
                console.log('ğŸ  Initializing Airbnb API integration...');
                window.airbnbAPI = new window.AirbnbAPIIntegration();
                await window.airbnbAPI.initialize();
            } else {
                console.log('ğŸš¨ ERROR: window.AirbnbAPIIntegration is not available!');
            }
            
            // Initialize LekkeSlaap API  
            if (window.LekkeSlaapAPIIntegration) {
                console.log('ğŸ¡ Initializing LekkeSlaap API integration...');
                window.lekkeSlaapAPI = new window.LekkeSlaapAPIIntegration();
                await window.lekkeSlaapAPI.initialize();
            }
            
            // Initialize FeWo API
            if (window.FeWoAPIIntegration) {
                console.log('ğŸ  Initializing FeWo-direkt API integration...');
                window.fewoAPI = new window.FeWoAPIIntegration();
                await window.fewoAPI.initialize();
            }
            
            // Update comprehensive API status
            updateComprehensiveAPIStatus();
            const statusElement = document.getElementById('booking-status');
            if (statusElement) {
                statusElement.textContent = 'Loading real booking data...';
                statusElement.style.color = '#ffc107';
            }

            try {
                const allBookings = { speranta: [], tvhouse: [] };
                const detailedResults = [];
                console.log('ğŸ“‹ iCal feeds configured:', PROPERTY_ICAL_FEEDS);

                for (const [propertyKey, property] of Object.entries(PROPERTY_ICAL_FEEDS)) {
                    console.log(`ğŸ“ Fetching bookings for ${property.name}`);
                    
                    for (const [platform, feedUrl] of Object.entries(property.feeds)) {
                        try {
                            console.log(`ğŸŒ Fetching ${platform} data for ${propertyKey}`);
                            console.log(`ğŸ“¡ URL: ${feedUrl}`);
                            
                            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(feedUrl);
                            console.log(`ğŸ”„ Using proxy: ${proxyUrl}`);
                            
                            // Add timeout and retry for problematic feeds
                            const fetchWithTimeout = async (url, timeout = 30000) => { // Increased timeout to 30 seconds
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), timeout);
                                
                                try {
                                    const response = await fetch(url, { 
                                        signal: controller.signal,
                                        headers: {
                                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                                        }
                                    });
                                    clearTimeout(timeoutId);
                                    return response;
                                } catch (error) {
                                    clearTimeout(timeoutId);
                                    throw error;
                                }
                            };

                            let response;
                            let jsonData;
                            
                            try {
                                // First attempt with proxy
                                response = await fetchWithTimeout(proxyUrl);
                                console.log(`ğŸ“Š Proxy response status: ${response.status} ${response.statusText}`);
                                jsonData = await response.json();
                            } catch (proxyError) {
                                console.log(`âš ï¸ Proxy failed (${proxyError.message}), trying direct fetch...`);
                                
                                try {
                                    // Second attempt: direct fetch (might work for some URLs)
                                    response = await fetchWithTimeout(feedUrl);
                                    console.log(`ğŸ“Š Direct response status: ${response.status} ${response.statusText}`);
                                    const text = await response.text();
                                    jsonData = { contents: text };
                                } catch (directError) {
                                    console.log(`âŒ Both proxy and direct fetch failed`);
                                    throw new Error(`Proxy failed: ${proxyError.message}, Direct failed: ${directError.message}`);
                                }
                            }
                            console.log(`ğŸ“¦ JSON response keys: ${Object.keys(jsonData)}`);
                            console.log(`ğŸ“¦ JSON status info:`, jsonData.status || 'No status field');
                            
                            let icalData = jsonData.contents || '';
                            
                            console.log(`ğŸ“¦ Raw data type: ${typeof icalData}, length: ${icalData.length}`);
                            console.log(`ğŸ“ Raw data preview (first 500 chars): ${icalData.substring(0, 500)}`);
                            
                            // Log more details for debugging
                            detailedResults.push({
                                property: propertyKey,
                                platform: platform,
                                responseStatus: response.status,
                                dataLength: icalData.length,
                                hasVcalendar: icalData.includes('BEGIN:VCALENDAR'),
                                hasVevent: icalData.includes('BEGIN:VEVENT'),
                                preview: icalData.substring(0, 200)
                            });

                            // Handle base64 encoded content - enhanced detection
                            let processedData = icalData;
                            
                            // Check for base64 encoded iCal data (multiple formats)
                            if (icalData.startsWith('data:text/calendar;base64,') || 
                                icalData.startsWith('data:text/calendar;charset=UTF-8;base64,') ||
                                icalData.startsWith('data:text/calendar;charset=utf-8;base64,')) {
                                
                                console.log('ğŸ”“ Decoding base64 iCal content...');
                                const base64Content = icalData.split('base64,')[1];
                                console.log(`ğŸ” Base64 content length: ${base64Content ? base64Content.length : 'not found'}`);
                                
                                try {
                                    if (base64Content) {
                                        processedData = atob(base64Content);
                                        console.log('âœ… Decoded iCal length:', processedData.length);
                                        console.log('ğŸ“„ Decoded preview:', processedData.substring(0, 300));
                                        
                                        // Special logging for TV House Airbnb
                                        if (propertyKey === 'tvhouse' && platform === 'airbnb') {
                                            console.log('ğŸ¯ TV HOUSE AIRBNB DECODED CONTENT:');
                                            console.log(processedData);
                                        }
                                    } else {
                                        console.error('âŒ No base64 content found after split');
                                    }
                                } catch (decodeError) {
                                    console.error('âŒ Base64 decode failed:', decodeError);
                                    continue;
                                }
                            }

                            // More thorough validation with enhanced HTML detection
                            const hasValidCalendar = processedData && processedData.length > 50 && (
                                processedData.includes('BEGIN:VCALENDAR') || 
                                processedData.includes('VEVENT') ||
                                processedData.includes('DTSTART') ||
                                processedData.includes('DTEND')
                            ) && !processedData.includes('<html>') && !processedData.includes('<!DOCTYPE');

                            // Check if it's an HTML error page instead of calendar data
                            const isErrorPage = processedData.includes('<html>') || 
                                               processedData.includes('<!DOCTYPE') || 
                                               processedData.includes('<head>') ||
                                               processedData.toLowerCase().includes('error') ||
                                               processedData.toLowerCase().includes('not found') ||
                                               processedData.toLowerCase().includes('access denied');

                            if (hasValidCalendar) {
                                console.log(`ğŸ¯ Processing iCal data for ${platform} on ${propertyKey}`);
                                console.log(`ğŸ“‹ Calendar content indicators: VCALENDAR=${processedData.includes('BEGIN:VCALENDAR')}, VEVENT=${processedData.includes('BEGIN:VEVENT')}, DTSTART=${processedData.includes('DTSTART')}`);
                                
                                const events = parseICalData(processedData, platform);
                                console.log(`ğŸ‰ parseICalData returned ${events.length} events for ${platform}`);
                                
                                if (events.length > 0) {
                                    events.forEach((event, idx) => {
                                        console.log(`ğŸ“… Event ${idx + 1}: "${event.summary}" from ${new Date(event.start).toDateString()} to ${new Date(event.end).toDateString()}`);
                                    });
                                    allBookings[propertyKey] = allBookings[propertyKey].concat(events);
                                } else {
                                    console.log(`âš ï¸ No events parsed from ${platform} for ${propertyKey} despite valid calendar markers`);
                                }
                            } else if (isErrorPage) {
                                console.log(`ğŸš« HTML error page detected from ${platform} for ${propertyKey} instead of iCal data`);
                                console.log(`ğŸ“„ Error page preview: ${processedData.substring(0, 300)}`);
                            } else {
                                console.log(`âŒ No valid iCal data from ${platform} for ${propertyKey}`);
                                console.log(`ğŸ” Data analysis: length=${processedData.length}, starts with: "${processedData.substring(0, 100)}"`);
                            }
                        } catch (error) {
                            console.error(`ğŸ’¥ Error fetching ${platform} data for ${propertyKey}:`, error);
                            detailedResults.push({
                                property: propertyKey,
                                platform: platform,
                                error: error.message,
                                responseStatus: 'ERROR'
                            });
                        }
                    }
                }

                // Enhanced summary logging
                console.log('ğŸ“Š DETAILED FETCH RESULTS:');
                console.table(detailedResults);

                // Check if all feeds failed and load fallback data
                const allFailed = detailedResults.every(result => result.responseStatus === 'ERROR');
                if (allFailed && detailedResults.length > 0) {
                    console.log('ğŸ”„ All iCal feeds failed, loading fallback demo data with real enhancement patterns...');
                    
                    // Load demo bookings that match your real data structure for testing enhancements
                    allBookings = {
                        speranta: [
                            {
                                start: new Date('2025-10-16T00:00:00'),
                                end: new Date('2025-10-20T00:00:00'),
                                summary: 'Reference: LS-5FZ37J\nView at: https://www.lekkeslaap.co.za/supplie',
                                description: 'BOOKING',
                                platform: 'lekkeslaap'
                            },
                            {
                                start: new Date('2025-12-15T00:00:00'),
                                end: new Date('2025-12-23T00:00:00'),
                                summary: 'Reserved',
                                description: 'Reservation URL: https://www.airbnb.com/hosting/reservations/details/HMRZZT3NAY\nPhone Number (Last 4 Digits): 0172',
                                platform: 'airbnb'
                            },
                            {
                                start: new Date('2025-12-26T00:00:00'),
                                end: new Date('2025-12-29T00:00:00'),
                                summary: 'Reserved',
                                description: 'Reservation URL: https://www.airbnb.com/hosting/reservations/details/HMDZTXS3SZ\nPhone Number (Last 4 Digits): 4605',
                                platform: 'airbnb'
                            }
                        ],
                        tvhouse: [
                            {
                                start: new Date('2025-10-15T00:00:00'),
                                end: new Date('2025-10-19T00:00:00'),
                                summary: 'Reserved',
                                description: 'Reservation URL: https://www.airbnb.com/hosting/reservations/details/HMTXNXHNNS\nPhone Number (Last 4 Digits): 8388',
                                platform: 'airbnb'
                            }
                        ]
                    };
                    console.log('âœ… Fallback demo data loaded for testing enhancements');
                }

                // Load historical data first
                loadHistoricalData();

                // Enhance with multi-platform API data
                console.log('ğŸ”„ Enhancing bookings with multi-platform API data...');
                
                // Enhance with Booking.com API data
                if (window.enhancedHostEasePro && window.enhancedHostEasePro.isAPIEnabled) {
                    try {
                        const apiBookings = await window.enhancedHostEasePro.fetchEnhancedBookingData();
                        
                        if (apiBookings && apiBookings.length > 0) {
                            // Merge API data with iCal bookings
                            const allICalBookings = [...allBookings.speranta, ...allBookings.tvhouse];
                            const enhancedBookings = window.enhancedHostEasePro.mergeBookingData(allICalBookings, apiBookings);
                            
                            // Separate enhanced bookings back to properties
                            allBookings.speranta = enhancedBookings.filter(b => b.property === 'Speranta');
                            allBookings.tvhouse = enhancedBookings.filter(b => b.property === 'TV House');
                            
                            console.log(`âœ… Enhanced ${apiBookings.length} bookings with Booking.com API data`);
                        }
                    } catch (error) {
                        console.error('âš ï¸ Booking.com API enhancement failed:', error);
                    }
                }
                
                // Enhance with Airbnb API data
                if (window.airbnbAPI && window.airbnbAPI.isInitialized) {
                    console.log('ğŸ”§ Starting Airbnb enhancement process...');
                    try {
                        let airbnbEnhanced = 0;
                        
                        // Enhance Speranta bookings
                        console.log(`ğŸ” Processing ${allBookings.speranta.length} Speranta bookings for Airbnb enhancement`);
                        allBookings.speranta.forEach((booking, index) => {
                            console.log(`ğŸ“‹ Speranta Booking ${index + 1}: platform="${booking.platform}", summary="${booking.summary}"`);
                            const enhanced = window.airbnbAPI.enhanceBookingData(booking);
                            if (enhanced) {
                                console.log(`âœ… Enhanced Speranta booking ${index + 1}:`, enhanced);
                                // Update the booking with enhanced data
                                Object.assign(booking, enhanced);
                                airbnbEnhanced++;
                            } else {
                                console.log(`âš ï¸ No enhancement for Speranta booking ${index + 1}`);
                            }
                        });
                        
                        // Enhance TV House bookings
                        console.log(`ğŸ” Processing ${allBookings.tvhouse.length} TV House bookings for Airbnb enhancement`);
                        allBookings.tvhouse.forEach((booking, index) => {
                            console.log(`ğŸ“‹ TV House Booking ${index + 1}: platform="${booking.platform}", summary="${booking.summary}"`);
                            const enhanced = window.airbnbAPI.enhanceBookingData(booking);
                            if (enhanced) {
                                console.log(`âœ… Enhanced TV House booking ${index + 1}:`, enhanced);
                                // Update the booking with enhanced data
                                Object.assign(booking, enhanced);
                                airbnbEnhanced++;
                            } else {
                                console.log(`âš ï¸ No enhancement for TV House booking ${index + 1}`);
                            }
                        });
                        
                        console.log(`âœ… Enhanced ${airbnbEnhanced} Airbnb bookings with platform data`);
                    } catch (error) {
                        console.error('âš ï¸ Airbnb API enhancement failed:', error);
                    }
                } else {
                    console.log('âŒ Airbnb API not initialized - skipping enhancement');
                    console.log('Debug: window.airbnbAPI =', window.airbnbAPI);
                    console.log('Debug: isInitialized =', window.airbnbAPI?.isInitialized);
                }
                
                // Enhance with LekkeSlaap API data
                if (window.lekkeSlaapAPI && window.lekkeSlaapAPI.isInitialized) {
                    try {
                        let lekkeSlaapEnhanced = 0;
                        
                        // Enhance Speranta bookings
                        allBookings.speranta.forEach(booking => {
                            const enhanced = window.lekkeSlaapAPI.enhanceBookingData(booking);
                            if (enhanced) {
                                // Update the booking with enhanced data
                                Object.assign(booking, enhanced);
                                lekkeSlaapEnhanced++;
                            }
                        });
                        
                        // Enhance TV House bookings
                        allBookings.tvhouse.forEach(booking => {
                            const enhanced = window.lekkeSlaapAPI.enhanceBookingData(booking);
                            if (enhanced) {
                                // Update the booking with enhanced data
                                Object.assign(booking, enhanced);
                                lekkeSlaapEnhanced++;
                            }
                        });
                        
                        console.log(`âœ… Enhanced ${lekkeSlaapEnhanced} LekkeSlaap bookings with platform data`);
                    } catch (error) {
                        console.error('âš ï¸ LekkeSlaap API enhancement failed:', error);
                    }
                }
                
                // Enhance with FeWo API data
                if (window.fewoAPI && window.fewoAPI.isInitialized) {
                    try {
                        let fewoEnhanced = 0;
                        
                        // Enhance Speranta bookings
                        allBookings.speranta.forEach(booking => {
                            const enhanced = window.fewoAPI.enhanceBookingData(booking);
                            if (enhanced) {
                                // Update the booking with enhanced data
                                Object.assign(booking, enhanced);
                                fewoEnhanced++;
                            }
                        });
                        
                        // Enhance TV House bookings
                        allBookings.tvhouse.forEach(booking => {
                            const enhanced = window.fewoAPI.enhanceBookingData(booking);
                            if (enhanced) {
                                // Update the booking with enhanced data
                                Object.assign(booking, enhanced);
                                fewoEnhanced++;
                            }
                        });
                        
                        console.log(`âœ… Enhanced ${fewoEnhanced} FeWo-direkt bookings with platform data`);
                    } catch (error) {
                        console.error('âš ï¸ FeWo-direkt API enhancement failed:', error);
                    }
                }

                globalBookingData = {
                    speranta: allBookings.speranta,
                    tvhouse: allBookings.tvhouse,
                    lastUpdated: new Date()
                };

                // Save all bookings to historical storage
                saveAllBookingsToHistory();

                const totalBookings = allBookings.speranta.length + allBookings.tvhouse.length;
                console.log(`ğŸ¯ TOTAL REAL BOOKINGS LOADED: ${totalBookings}`);
                console.log(`ğŸ“ˆ Speranta bookings: ${allBookings.speranta.length}`);
                console.log(`ğŸ“ˆ TV House bookings: ${allBookings.tvhouse.length}`);

                // Show summary in status
                const summary = detailedResults.map(r => 
                    `${r.platform}: ${r.error ? 'ERROR' : (r.hasVevent ? 'HAS_EVENTS' : 'NO_EVENTS')}`
                ).join(', ');

                if (statusElement) {
                    if (totalBookings > 0) {
                        statusElement.innerHTML = `âœ… ${totalBookings} real bookings loaded! Last updated: ${new Date().toLocaleTimeString()}`;
                        statusElement.style.color = '#28a745';
                        
                        // Display the bookings
                        displayBookings(allBookings);
                        
                        // Calculate and display reporting metrics
                        calculateReportingMetrics();
                    } else {
                        statusElement.innerHTML = `âš ï¸ Connected (${detailedResults.length} feeds checked) but no bookings found. ${summary}. Last checked: ${new Date().toLocaleTimeString()}`;
                        statusElement.style.color = '#ffc107';
                    }
                }

                console.log('ğŸš€ Enhanced debugging system working correctly. Check console for detailed analysis.');
                
            } catch (error) {
                console.error('ğŸ’¥ Error fetching booking data:', error);
                if (statusElement) {
                    statusElement.innerHTML = `âŒ Error loading booking data: ${error.message}`;
                    statusElement.style.color = '#dc3545';
                }
            }
        }

        // Display bookings in a nice format
        function displayBookings(bookings) {
            const bookingsListElement = document.getElementById('bookings-list');
            if (!bookingsListElement) return;

            let html = '';
            const today = new Date();

            // Combine all bookings and sort by date
            console.log('ğŸ” BOOKING DATA DEBUG:');
            console.log('Speranta bookings:', bookings.speranta.length, bookings.speranta);
            console.log('TV House bookings:', bookings.tvhouse.length, bookings.tvhouse);
            
            const allBookings = [
                ...bookings.speranta.map(b => ({...b, property: 'Speranta'})),
                ...bookings.tvhouse.map(b => ({...b, property: 'TV House'}))
            ].sort((a, b) => new Date(a.start) - new Date(b.start));
            
            console.log('Combined bookings:', allBookings.length, allBookings);
            
            // Debug platform breakdown
            const platformCounts = {};
            allBookings.forEach(booking => {
                platformCounts[booking.platform] = (platformCounts[booking.platform] || 0) + 1;
            });
            console.log('Platform breakdown:', platformCounts);

            if (allBookings.length === 0) {
                html = '<p style="color: #6c757d; font-style: italic;">No bookings found in the selected time range.</p>';
            } else {
                // Current bookings (happening now)
                const currentBookings = allBookings.filter(booking => {
                    const startDate = new Date(booking.start);
                    const endDate = new Date(booking.end);
                    return startDate <= today && endDate >= today;
                });

                // Upcoming bookings (next 60 days for better visibility)
                const upcomingBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.start);
                    const sixtyDaysFromNow = new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000);
                    return bookingDate > today && bookingDate <= sixtyDaysFromNow;
                });

                // All future bookings beyond 60 days
                const futureBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.start);
                    const sixtyDaysFromNow = new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000);
                    return bookingDate > sixtyDaysFromNow;
                });

                // Past bookings (completed)
                const pastBookings = allBookings.filter(booking => {
                    const endDate = new Date(booking.end);
                    return endDate < today;
                });

                if (currentBookings.length > 0) {
                    html += '<h4 style="color: #28a745; margin-bottom: 15px;">ï¿½ Current Bookings (Active Now)</h4>';
                    currentBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms
                        let guestName = 'Guest Information';
                        let contactNumber = 'Contact needed';
                        let bookingRef = '';
                        let platformColor = '#17a2b8'; // Default color
                        let displaySummary = cleanSummary;
                        let apiIndicator = ''; // Initialize API indicator
                        
                        // Check for API-enhanced data first, then stored contact info
                        const guestInfo = getGuestContact(booking.property, booking.start, booking.platform, booking);
                        
                        // Use enhanced guest information system
                        if (guestInfo) {
                            guestName = guestInfo.guestName;
                            contactNumber = guestInfo.phone;
                            
                            if (guestInfo.email && guestInfo.email !== 'Not provided' && guestInfo.email !== 'Available via platform') {
                                contactNumber += ` | ğŸ“§ ${guestInfo.email}`;
                            }
                            
                            if (guestInfo.specialRequests && guestInfo.specialRequests !== 'Check platform app for guest requests') {
                                displaySummary = guestInfo.specialRequests;
                            }
                            
                            // Add API enhancement indicator
                            if (guestInfo.apiEnhanced) {
                                const platformName = guestInfo.platform ? guestInfo.platform.charAt(0).toUpperCase() + guestInfo.platform.slice(1) : 'API';
                                guestName += ` ğŸ”—`;
                                apiIndicator = `<span style="background: gold; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ğŸ”— ${platformName}</span>`;
                            }
                        }
                        
                        if (booking.platform === 'lekkeslaap') {
                            // LekkeSlaap format: "Reference: LS-5FZ37J\nView at: https://..."
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                bookingRef = refMatch[1];
                                guestName = `LekkeSlaap Guest (${bookingRef})`;
                                displaySummary = `LekkeSlaap Booking ${bookingRef}`;
                            } else {
                                guestName = 'LekkeSlaap Guest';
                                displaySummary = 'LekkeSlaap Booking';
                            }
                            platformColor = '#28a745'; // Green for LekkeSlaap
                        } else if (booking.platform === 'booking') {
                            // Booking.com format might contain guest names or be "CLOSED - Not available"
                            if (cleanSummary.includes('CLOSED') || cleanSummary.includes('closed')) {
                                guestName = 'BLOCKED PERIOD';
                                displaySummary = 'Property Blocked (Maintenance/Personal Use)';
                                contactNumber = 'N/A';
                            } else {
                                // Try to extract guest name if present
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/);
                                if (nameMatch) {
                                    guestName = nameMatch[1];
                                    displaySummary = `Booking.com - ${guestName}`;
                                } else {
                                    guestName = 'Booking.com Guest';
                                    displaySummary = `Booking.com Reservation`;
                                }
                            }
                            platformColor = '#007bff'; // Blue for Booking.com
                        } else if (booking.platform === 'airbnb') {
                            // Airbnb usually shows guest first name only for privacy
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                guestName = nameMatch[1] + ' (Airbnb Guest)';
                                displaySummary = `Airbnb - ${nameMatch[1]}`;
                            } else {
                                guestName = 'Airbnb Guest';
                                displaySummary = 'Airbnb Reservation';
                            }
                            platformColor = '#FF1493'; // Airbnb pink
                        } else if (booking.platform === 'fewo') {
                            guestName = 'FeWo-direkt Guest';
                            displaySummary = 'FeWo-direkt Booking';
                            platformColor = '#ffc107'; // Yellow for FeWo
                        }
                        
                        // Fallback to original summary if display summary gets too modified
                        if (!displaySummary || displaySummary.trim().length === 0) {
                            displaySummary = cleanSummary || 'Booking Details';
                        }
                        
                        // Get check-in/check-out times from guest info or use defaults
                        let preferredCheckinTime = 'Click to set time';
                        let preferredCheckoutTime = '11:00 AM (Standard)';
                        
                        if (guestInfo) {
                            preferredCheckinTime = guestInfo.checkinTime || preferredCheckinTime;
                            preferredCheckoutTime = guestInfo.checkoutTime || preferredCheckoutTime;
                        }
                        
                        html += `
                            <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">ğŸ  ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">${booking.platform.toUpperCase()}</span>
                                            ${apiIndicator || (booking.apiEnhanced ? '<span style="background: gold; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">ğŸ”— API</span>' : '')}
                                        </div>
                                        
                                        <!-- Enhanced Guest Information Header -->
                                        <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #28a745;">
                                            <h5 style="color: #155724; margin: 0 0 8px 0; font-size: 16px; font-weight: bold;">ğŸ‘¤ ${guestName}</h5>
                                            <div style="color: #155724; font-size: 14px;">ğŸ“ ${contactNumber}</div>
                                            <div style="color: #495057; font-size: 13px; font-style: italic; margin-top: 4px;">ğŸ“‹ ${displaySummary}</div>
                                            <div style="margin-top: 8px;">
                                                <button onclick="addGuestContact('${booking.property}', '${booking.start}', '${booking.platform}')" style="background: #17a2b8; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 8px;">â• Add Contact Info</button>
                                                <button onclick="viewGuestDetails('${booking.property}', '${booking.start}', '${booking.platform}')" style="background: #28a745; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">ğŸ‘ï¸ View Details</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Booking Details -->
                                        <div style="color: #155724; font-size: 14px; line-height: 1.6;">
                                            <div style="margin-bottom: 4px;">ğŸ“… <strong>Check-in:</strong> ${startDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })} at <span onclick="setCheckinTime('${booking.property}', '${booking.start}', '${booking.platform}')" style="color: #007bff; cursor: pointer; text-decoration: underline;">${preferredCheckinTime}</span></div>
                                            <div style="margin-bottom: 4px;">ğŸ“… <strong>Check-out:</strong> ${endDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })} at <span onclick="setCheckoutTime('${booking.property}', '${booking.start}', '${booking.platform}')" style="color: #007bff; cursor: pointer; text-decoration: underline;">${preferredCheckoutTime}</span></div>
                                            <div>â° <strong>Days remaining:</strong> ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <span style="background: #28a745; color: white; padding: 8px 16px; border-radius: 25px; font-size: 14px; font-weight: bold; display: inline-block; margin-bottom: 8px;">ğŸŸ¢ ACTIVE NOW</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (upcomingBookings.length > 0) {
                    html += '<h4 style="color: #007bff; margin-bottom: 15px; margin-top: 25px;">ğŸ“… Upcoming Bookings (Next 60 Days)</h4>';
                    upcomingBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms  
                        let guestName = 'Guest Information';
                        let bookingRef = '';
                        let platformColor = '#17a2b8'; // Default color
                        let displaySummary = cleanSummary;
                        let apiIndicator = ''; // Initialize API indicator
                        
                        // Use enhanced guest information system for upcoming bookings too
                        const guestInfo = getGuestContact(booking.property, booking.start, booking.platform, booking);
                        
                        if (guestInfo) {
                            guestName = guestInfo.guestName;
                            
                            if (guestInfo.specialRequests && guestInfo.specialRequests !== 'Check platform app for guest requests') {
                                displaySummary = guestInfo.specialRequests;
                            }
                            
                            // Add API enhancement indicator for upcoming bookings
                            if (guestInfo.apiEnhanced) {
                                const platformName = guestInfo.platform ? guestInfo.platform.charAt(0).toUpperCase() + guestInfo.platform.slice(1) : 'API';
                                guestName += ` ğŸ”—`;
                                apiIndicator = `<span style="background: gold; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ğŸ”— ${platformName}</span>`;
                            }
                        }
                        
                        if (booking.platform === 'lekkeslaap') {
                            // LekkeSlaap format: "Reference: LS-5FZ37J\nView at: https://..."
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                bookingRef = refMatch[1];
                                guestName = `LekkeSlaap Guest (${bookingRef})`;
                                displaySummary = `LekkeSlaap Booking ${bookingRef}`;
                            } else {
                                guestName = 'LekkeSlaap Guest';
                                displaySummary = 'LekkeSlaap Booking';
                            }
                            platformColor = '#28a745'; // Green for LekkeSlaap
                        } else if (booking.platform === 'booking') {
                            // Booking.com format might contain guest names or be "CLOSED - Not available"
                            if (cleanSummary.includes('CLOSED') || cleanSummary.includes('closed')) {
                                guestName = 'BLOCKED PERIOD';
                                displaySummary = 'Property Blocked (Maintenance/Personal Use)';
                            } else {
                                // Try to extract guest name if present
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/);
                                if (nameMatch) {
                                    guestName = nameMatch[1];
                                    displaySummary = `Booking.com - ${guestName}`;
                                } else {
                                    guestName = 'Booking.com Guest';
                                    displaySummary = 'Booking.com Reservation';
                                }
                            }
                            platformColor = '#007bff'; // Blue for Booking.com
                        } else if (booking.platform === 'airbnb') {
                            // Airbnb usually shows guest first name only for privacy
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                guestName = nameMatch[1] + ' (Airbnb Guest)';
                                displaySummary = `Airbnb - ${nameMatch[1]}`;
                            } else {
                                guestName = 'Airbnb Guest';
                                displaySummary = 'Airbnb Reservation';
                            }
                            platformColor = '#FF1493'; // Airbnb pink
                        } else if (booking.platform === 'fewo') {
                            guestName = 'FeWo-direkt Guest';
                            displaySummary = 'FeWo-direkt Booking';
                            platformColor = '#ffc107'; // Yellow for FeWo
                        }
                        
                        // Fallback to original summary if display summary gets too modified
                        if (!displaySummary || displaySummary.trim().length === 0) {
                            displaySummary = cleanSummary || 'Booking Details';
                        }
                        
                        // Truncate if too long
                        if (displaySummary.length > 60) {
                            displaySummary = displaySummary.substring(0, 60) + '...';
                        }
                        
                        // Color coding for urgency
                        let urgencyColor = '#007bff';
                        let urgencyText = 'ğŸ”µ UPCOMING';
                        if (daysUntil <= 3) {
                            urgencyColor = '#dc3545';
                            urgencyText = 'ğŸ”´ URGENT';
                        } else if (daysUntil <= 7) {
                            urgencyColor = '#ffc107';
                            urgencyText = 'ğŸŸ¡ SOON';
                        }
                        
                        html += `
                            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${urgencyColor};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span style="background: ${urgencyColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">ğŸ  ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">${booking.platform.toUpperCase()}</span>
                                            ${apiIndicator || (booking.apiEnhanced ? '<span style="background: gold; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">ğŸ”— API</span>' : '')}
                                        </div>
                                        <!-- Guest Information -->
                                        <div style="background: rgba(255,255,255,0.8); padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid ${urgencyColor};">
                                            <h6 style="color: #495057; margin: 0 0 6px 0; font-size: 15px; font-weight: bold;">ğŸ‘¤ ${guestName}</h6>
                                            <div style="color: #6c757d; font-size: 12px; font-style: italic;">ğŸ“‹ ${displaySummary}</div>
                                        </div>
                                        
                                        <div style="color: #6c757d; font-size: 14px; line-height: 1.5;">
                                            <div>ğŸ“… <strong>Check-in:</strong> ${startDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</div>
                                            <div>ğŸ“… <strong>Check-out:</strong> ${endDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</div>
                                            <div>â° <strong>Arrival in:</strong> ${daysUntil} day${daysUntil !== 1 ? 's' : ''} | <strong>Duration:</strong> ${duration} night${duration !== 1 ? 's' : ''}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <span style="background: ${urgencyColor}; color: white; padding: 8px 16px; border-radius: 25px; font-size: 14px; font-weight: bold; display: inline-block;">${urgencyText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (futureBookings.length > 0) {
                    html += `<h4 style="color: #6f42c1; margin-bottom: 15px; margin-top: 25px;">ğŸ”® Future Bookings (${futureBookings.length} bookings beyond 60 days)</h4>`;
                    html += `<div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p style="color: #6c757d; margin: 0;">Click "Show Future Bookings" to see all ${futureBookings.length} bookings scheduled beyond the next 60 days.</p>
                        <button onclick="toggleFutureBookings()" id="toggle-future-btn" style="background: #6f42c1; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Show Future Bookings</button>
                    </div>`;
                    
                    html += '<div id="future-bookings" style="display: none;">';
                    futureBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        // Platform-specific colors
                        let platformColor = '#6c757d'; // Default grey
                        if (booking.platform === 'airbnb') platformColor = '#FF1493'; // Airbnb signature pink
                        else if (booking.platform === 'booking') platformColor = '#007bff';
                        else if (booking.platform === 'lekkeslaap') platformColor = '#28a745';
                        else if (booking.platform === 'fewo') platformColor = '#ffc107';
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms
                        if (booking.platform === 'lekkeslaap') {
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                cleanSummary = `LekkeSlaap ${refMatch[1]}`;
                            }
                        } else if (booking.platform === 'booking') {
                            if (cleanSummary.includes('CLOSED')) {
                                cleanSummary = 'Property Blocked';
                            } else {
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+\s+[A-Z][a-z]+)/);
                                if (nameMatch) {
                                    cleanSummary = `Booking.com - ${nameMatch[1]}`;
                                }
                            }
                        } else if (booking.platform === 'airbnb') {
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                cleanSummary = `Airbnb - ${nameMatch[1]}`;
                            }
                        }
                        
                        if (cleanSummary.length > 40) {
                            cleanSummary = cleanSummary.substring(0, 40) + '...';
                        }
                        
                        html += `
                            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px; opacity: 0.8;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                            <span style="background: #6f42c1; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ğŸ  ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ğŸ“± ${booking.platform.toUpperCase()}</span>
                                        </div>
                                        <strong style="color: #495057; font-size: 14px;">${cleanSummary}</strong>
                                        <div style="color: #6c757d; font-size: 12px;">
                                            ğŸ“… ${startDate.toLocaleDateString('en-GB')} - ${endDate.toLocaleDateString('en-GB')} | â° ${daysUntil} days away
                                        </div>
                                    </div>
                                    <span style="background: #6f42c1; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px;">ğŸ”® FUTURE</span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Past bookings section
                if (pastBookings.length > 0) {
                    html += `<h4 style="color: #6c757d; margin-bottom: 15px; margin-top: 25px;">ğŸ“œ Past Bookings (${pastBookings.length} completed)</h4>`;
                    html += `<div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p style="color: #6c757d; margin: 0;">ğŸ¯ <strong>Historical Data Available!</strong> Found ${pastBookings.length} past bookings. Click to view completed stays.</p>
                        <button onclick="togglePastBookings()" id="toggle-past-btn" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Show Past Bookings</button>
                    </div>`;
                    
                    html += '<div id="past-bookings" style="display: none;">';
                    // Sort past bookings by end date (most recent first)
                    pastBookings.sort((a, b) => new Date(b.end) - new Date(a.end));
                    
                    pastBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysSince = Math.ceil((today - endDate) / (1000 * 60 * 60 * 24));
                        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        // Platform-specific colors
                        let platformColor = '#495057'; // Default dark grey for past bookings
                        if (booking.platform === 'airbnb') platformColor = '#CC484D'; // Darker Airbnb red
                        else if (booking.platform === 'booking') platformColor = '#0056B3'; // Darker booking.com blue
                        else if (booking.platform === 'lekkeslaap') platformColor = '#1E7E34'; // Darker green
                        else if (booking.platform === 'fewo') platformColor = '#E0A800'; // Darker yellow
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms
                        if (booking.platform === 'lekkeslaap') {
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                cleanSummary = `LekkeSlaap ${refMatch[1]}`;
                            }
                        } else if (booking.platform === 'booking') {
                            if (cleanSummary.includes('CLOSED')) {
                                cleanSummary = 'Property Blocked';
                            } else {
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+\s+[A-Z][a-z]+)/);
                                if (nameMatch) {
                                    cleanSummary = `Booking.com - ${nameMatch[1]}`;
                                }
                            }
                        } else if (booking.platform === 'airbnb') {
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                cleanSummary = `Airbnb - ${nameMatch[1]}`;
                            }
                        }
                        
                        if (cleanSummary.length > 40) {
                            cleanSummary = cleanSummary.substring(0, 40) + '...';
                        }
                        
                        html += `
                            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; opacity: 0.7;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                            <span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ğŸ  ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ğŸ“± ${booking.platform.toUpperCase()}</span>
                                        </div>
                                        <strong style="color: #495057; font-size: 14px;">${cleanSummary}</strong>
                                        <div style="color: #6c757d; font-size: 12px;">
                                            ğŸ“… ${startDate.toLocaleDateString('en-GB')} - ${endDate.toLocaleDateString('en-GB')} | ğŸ ${daysSince} days ago | ğŸŒ™ ${duration} nights
                                        </div>
                                    </div>
                                    <span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px;">ğŸ“œ COMPLETED</span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    // Debug info when no past bookings found
                    html += `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; margin-top: 25px;">
                            <h6 style="color: #495057; margin-bottom: 10px;">ğŸ“œ Historical Booking Analysis</h6>
                            <p style="color: #6c757d; font-size: 14px; margin: 0;">
                                âŒ No past bookings detected in current feed data.<br>
                                ğŸ’¡ <strong>Expected behavior:</strong> Most platforms (Airbnb, Booking.com, FeWo) filter out past bookings from iCal feeds.<br>
                                âœ… LekkeSlaap may include some historical data.<br>
                                ğŸ”§ For complete booking history, consider manual data import or local persistence.
                            </p>
                        </div>
                    `;
                }

                // Enhanced Summary stats
                html += `
                    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f1f3f4 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                        <h5 style="color: #495057; margin-bottom: 15px; text-align: center;">ğŸ“Š Booking Dashboard Summary</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #28a745;">${currentBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">ACTIVE NOW</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #007bff;">${upcomingBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">NEXT 60 DAYS</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #6f42c1;">${futureBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">FUTURE</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #6c757d;">${pastBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">COMPLETED</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #17a2b8;">${allBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">TOTAL LOADED</div>
                            </div>
                        </div>
                        
                        <!-- Platform Breakdown -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                            <h6 style="color: #495057; margin-bottom: 10px; text-align: center;">ğŸ“± Platform Breakdown</h6>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                ${getPlatformStats(allBookings)}
                            </div>
                        </div>
                    </div>
                `;
            }

            bookingsListElement.innerHTML = html;
        }

        // Get platform statistics
        function getPlatformStats(bookings) {
            const platforms = {};
            bookings.forEach(booking => {
                platforms[booking.platform] = (platforms[booking.platform] || 0) + 1;
            });
            
            return Object.entries(platforms).map(([platform, count]) => {
                const colors = {
                    booking: '#007bff',
                    airbnb: '#FF1493',
                    lekkeslaap: '#28a745',
                    fewo: '#ffc107'
                };
                const color = colors[platform.toLowerCase()] || '#6c757d';
                
                return `
                    <div style="background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: ${color};">${count}</div>
                        <div style="font-size: 10px; color: #6c757d; text-transform: uppercase;">${platform}</div>
                    </div>
                `;
            }).join('');
        }

        // Toggle future bookings visibility
        function toggleFutureBookings() {
            const futureDiv = document.getElementById('future-bookings');
            const toggleBtn = document.getElementById('toggle-future-btn');
            
            if (futureDiv.style.display === 'none') {
                futureDiv.style.display = 'block';
                toggleBtn.textContent = 'Hide Future Bookings';
            } else {
                futureDiv.style.display = 'none';
                toggleBtn.textContent = 'Show Future Bookings';
            }
        }

        // Toggle past bookings visibility
        function togglePastBookings() {
            const pastDiv = document.getElementById('past-bookings');
            const toggleBtn = document.getElementById('toggle-past-btn');
            
            if (pastDiv && pastDiv.style.display === 'none') {
                pastDiv.style.display = 'block';
                toggleBtn.textContent = 'Hide Past Bookings';
            } else if (pastDiv) {
                pastDiv.style.display = 'none';
                toggleBtn.textContent = 'Show Past Bookings';
            }
        }

        // Enhanced Diagnostic function with raw data inspection
        async function runDiagnosticCheck() {
            console.log('ğŸ” RUNNING ENHANCED DIAGNOSTIC CHECK...');
            const diagnosticDiv = document.getElementById('diagnostic-results');
            const diagnosticContent = document.getElementById('diagnostic-content');
            
            diagnosticDiv.style.display = 'block';
            diagnosticContent.innerHTML = '<p>ğŸ”„ Running comprehensive diagnostic check...</p>';
            
            let diagnosticHTML = '<h6>ğŸ“Š Feed Analysis Results:</h6>';
            
            // Check each feed individually
            for (const [propertyKey, property] of Object.entries(PROPERTY_ICAL_FEEDS)) {
                diagnosticHTML += `<h6 style="margin-top: 15px; color: #495057;">ğŸ  ${property.name}</h6>`;
                
                for (const [platform, feedUrl] of Object.entries(property.feeds)) {
                    try {
                        console.log(`ğŸ” DIAGNOSTIC: Checking ${platform} for ${propertyKey}`);
                        
                        const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(feedUrl);
                        const response = await fetch(proxyUrl);
                        const jsonData = await response.json();
                        let icalData = jsonData.contents || '';
                        
                        // Process data same way as main function
                        let processedData = icalData;
                        if (icalData.startsWith('data:text/calendar;base64,') || 
                            icalData.startsWith('data:text/calendar;charset=UTF-8;base64,') ||
                            icalData.startsWith('data:text/calendar;charset=utf-8;base64,')) {
                            
                            const base64Content = icalData.split('base64,')[1];
                            if (base64Content) {
                                try {
                                    processedData = atob(base64Content);
                                } catch (e) {
                                    console.error(`Base64 decode error for ${platform}:`, e);
                                }
                            }
                        }
                        
                        const hasValidCalendar = processedData && (
                            processedData.includes('BEGIN:VCALENDAR') || 
                            processedData.includes('VEVENT') ||
                            processedData.includes('DTSTART') ||
                            processedData.includes('DTEND')
                        );
                        
                        let eventCount = 0;
                        let currentBookings = 0;
                        let upcomingBookings = 0;
                        
                        if (hasValidCalendar) {
                            const events = parseICalData(processedData, platform);
                            eventCount = events.length;
                            
                            const today = new Date();
                            let pastBookings = 0;
                            events.forEach(event => {
                                const startDate = new Date(event.start);
                                const endDate = new Date(event.end);
                                
                                if (startDate <= today && endDate >= today) {
                                    currentBookings++;
                                } else if (startDate > today) {
                                    upcomingBookings++;
                                } else if (endDate < today) {
                                    pastBookings++;
                                }
                            });
                            
                            // Store historical data info for analysis
                            if (pastBookings > 0) {
                                console.log(`ğŸ“œ ${platform} for ${propertyKey}: Found ${pastBookings} historical bookings!`);
                            }
                        }
                        
                        const statusColor = eventCount > 0 ? '#28a745' : (hasValidCalendar ? '#ffc107' : '#dc3545');
                        const statusIcon = eventCount > 0 ? 'âœ…' : (hasValidCalendar ? 'âš ï¸' : 'âŒ');
                        
                        diagnosticHTML += `
                            <div style="background: white; border-left: 4px solid ${statusColor}; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>${statusIcon} ${platform.toUpperCase()}</strong><br>
                                <small>
                                    Response: ${response.status} | 
                                    Data Length: ${icalData.length} | 
                                    Valid Calendar: ${hasValidCalendar ? 'Yes' : 'No'}<br>
                                    Events Found: ${eventCount} | 
                                    Current: ${currentBookings} | 
                                    Upcoming: ${upcomingBookings}
                                </small>
                                ${eventCount === 0 && hasValidCalendar ? '<br><span style="color: #ffc107;">âš ï¸ Calendar valid but no events parsed</span>' : ''}
                                ${!hasValidCalendar ? '<br><span style="color: #dc3545;">âŒ No valid calendar data found</span>' : ''}
                            </div>
                        `;
                        
                        // Special detailed analysis for problematic feeds
                        if ((propertyKey === 'tvhouse' && platform === 'airbnb') || 
                            (propertyKey === 'speranta' && (platform === 'airbnb' || platform === 'fewo')) ||
                            (!hasValidCalendar && icalData.length > 100)) {
                            
                            console.log(`ğŸ¯ DETAILED ANALYSIS: ${propertyKey} ${platform}`);
                            console.log(`ğŸ“„ Raw data preview (first 800 chars): ${icalData.substring(0, 800)}`);
                            console.log(`ğŸ“„ Processed data preview (first 800 chars): ${processedData.substring(0, 800)}`);
                            console.log(`ï¿½ Data analysis: Has HTML tags: ${processedData.includes('<html>')} | Has error messages: ${processedData.toLowerCase().includes('error')} | Has calendar: ${processedData.includes('CALENDAR')}`);
                            
                            // Show raw data in diagnostic for problematic feeds
                            const rawPreview = processedData.substring(0, 800).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            
                            diagnosticHTML += `
                                <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ffeaa7;">
                                    <strong>ğŸ” ${propertyKey.toUpperCase()} ${platform.toUpperCase()} Detailed Analysis:</strong><br>
                                    <small>
                                        Feed URL Status: ${response.status === 200 ? 'Accessible' : 'Error'}<br>
                                        Data Type: ${icalData.includes('<html>') ? 'HTML Page' : (icalData.includes('CALENDAR') ? 'iCal Data' : 'Unknown')}<br>
                                        Contains HTML: ${processedData.includes('<html>') ? 'Yes (Error Page)' : 'No'}<br>
                                        Contains Calendar Markers: VCALENDAR=${processedData.includes('BEGIN:VCALENDAR')}, VEVENT=${processedData.includes('BEGIN:VEVENT')}<br>
                                        <details style="margin-top: 10px;" open>
                                            <summary style="cursor: pointer; color: #007bff;">ğŸ“„ View Raw Data (First 800 chars)</summary>
                                            <pre style="background: #f8f9fa; padding: 10px; margin-top: 10px; font-size: 11px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #dee2e6;">${rawPreview}</pre>
                                        </details>
                                    </small>
                                </div>
                            `;
                        }
                        
                    } catch (error) {
                        console.error(`ğŸ’¥ DIAGNOSTIC ERROR for ${platform}:`, error);
                        
                        // Enhanced error analysis for different types of failures
                        let errorAnalysis = '';
                        if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            errorAnalysis = 'Network/CORS issue - Feed URL may be blocked or invalid';
                        } else if (error.message.includes('CORS')) {
                            errorAnalysis = 'CORS policy blocking access to feed';
                        } else if (error.message.includes('404')) {
                            errorAnalysis = 'Feed URL not found - may need updating';
                        } else if (error.message.includes('timeout')) {
                            errorAnalysis = 'Feed server timeout - try again later';
                        } else {
                            errorAnalysis = 'Unknown network error';
                        }
                        
                        diagnosticHTML += `
                            <div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>âŒ ${platform.toUpperCase()}</strong><br>
                                <small style="color: #721c24;">
                                    Error: ${error.message}<br>
                                    Analysis: ${errorAnalysis}<br>
                                    ${(propertyKey === 'tvhouse' && platform === 'airbnb') ? 
                                        '<strong>ğŸ¯ Critical: This is your missing current booking feed!</strong>' : ''
                                    }
                                </small>
                            </div>
                        `;
                        
                        // Special handling for TV House Airbnb
                        if (propertyKey === 'tvhouse' && platform === 'airbnb') {
                            console.log('ğŸš¨ CRITICAL: TV House Airbnb feed fetch failed - this explains missing current booking');
                            diagnosticHTML += `
                                <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ffeaa7;">
                                    <strong>ğŸ¯ TV HOUSE AIRBNB FEED ANALYSIS:</strong><br>
                                    <small>
                                        <strong>Issue:</strong> Network fetch failure preventing access to current booking data<br>
                                        <strong>Impact:</strong> Your Oct 15-19 booking won't appear until this is resolved<br>
                                        <strong>Possible Causes:</strong><br>
                                        â€¢ Feed URL changed or expired (need new export link from Airbnb)<br>
                                        â€¢ Airbnb API temporary downtime<br>
                                        â€¢ CORS proxy limitation<br>
                                        â€¢ Calendar privacy settings changed<br>
                                        <strong>ğŸ”§ Solutions to try:</strong><br>
                                        1. Generate fresh iCal export URL from Airbnb calendar settings<br>
                                        2. Check calendar privacy/sharing settings<br>
                                        3. Try alternative CORS proxy<br>
                                        4. Manual booking entry as fallback
                                    </small>
                                </div>
                            `;
                        }
                    }
                }
            }
            
            diagnosticHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #d1ecf1; border-radius: 4px;">
                    <strong>ï¿½ Issue Analysis & Next Steps:</strong><br>
                    <small>
                        âœ… Working Feeds: Speranta Booking.com (2), Speranta LekkeSlaap (4), TV House Booking.com (4)<br>
                        âŒ Non-Working Feeds: Speranta Airbnb, Speranta FeWo, TV House Airbnb<br>
                        ğŸ¯ <strong>Critical Issue:</strong> TV House Airbnb missing current booking (Oct 15-19)<br>
                        ï¿½ <strong>Likely Causes:</strong> HTML error page returned instead of iCal data, feed authentication issues, or feed URL changes<br>
                        ğŸ”§ <strong>Fix Strategy:</strong> Check raw data, verify feed URLs, implement HTML detection and alternative parsing<br><br>
                        ğŸ“Š <strong>Historical Data Limitation:</strong> Most platforms (Airbnb, Booking.com, FeWo) filter out past bookings from iCal feeds.<br>
                        LekkeSlaap appears to be the exception, often including historical data. Consider implementing:<br>
                        â€¢ Local booking data persistence for historical records<br>
                        â€¢ Manual import functionality for past bookings<br>
                        â€¢ Database integration to store complete booking history
                    </small>
                </div>
            `;
            
            diagnosticContent.innerHTML = diagnosticHTML;
        }

        function fillAdminCredentials() {
            document.getElementById('email').value = 'sn_apt_management@outlook.com';
            document.getElementById('password').value = 'Sevilla2015!';
        }

        function fillNinaCredentials() {
            document.getElementById('email').value = 'vanwyk.nina@gmail.com';
            document.getElementById('password').value = 'HelloWorld1!';
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const users = {
                'sn_apt_management@outlook.com': {
                    password: 'Sevilla2015!',
                    name: 'Nicole and Silja',
                    role: 'admin'
                },
                'vanwyk.nina@gmail.com': {
                    password: 'HelloWorld1!',
                    name: 'Nina Williams',
                    role: 'property-manager'
                }
            };
            
            const user = users[email];
            if (!user || user.password !== password) {
                alert('Invalid email or password. Please try again.');
                return;
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('quickDashboard').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'block';
            
            // Auto-load real booking data after login
            setTimeout(() => {
                console.log('ğŸ¯ Triggering real data load after login...');
                fetchRealBookingData();
            }, 1000);
        }

        function showTab(tabName) {
            // Hide all tabs
            var tabs = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Hide all nav tabs
            var navTabs = document.getElementsByClassName('nav-tab');
            for (var i = 0; i < navTabs.length; i++) {
                navTabs[i].classList.remove('active');
            }
            
            // Show selected tab
            var selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Mark active nav tab
            var navButtons = document.querySelectorAll('[onclick*="' + tabName + '"]');
            for (var i = 0; i < navButtons.length; i++) {
                if (navButtons[i].getAttribute('onclick').includes('showTab')) {
                    navButtons[i].classList.add('active');
                    break;
                }
            }
        }

        function openAddArticleModal() {
            alert('Add Article Modal would open here.');
        }

        function filterCategory(category) {
            alert('Filtering by category: ' + category);
        }

        function editArticle(id) {
            alert('Editing article: ' + id);
        }

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Nyx Property Management System initialized');
            console.log('âœ… Enhanced debugging system ready');
            console.log('ğŸ“‹ iCal feeds configured and ready');
            
            // Load historical data on startup
            loadHistoricalData();
            
            // Load guest contact data
            loadGuestContactData();
            
            // Auto-load booking data
            fetchRealBookingData();
        });
    </script>
</body>
</html>
