<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyx Property Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .logo {
            color: #667eea;
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .dashboard-section {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #333;
        }
        
        .quick-dashboard {
            display: none;
            margin-bottom: 20px;
        }
        
        .compact-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .compact-metric {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .compact-metric:hover {
            transform: translateY(-2px);
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: #007bff;
            color: white;
        }
        
        .nav-tab:hover {
            background: #0056b3;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .property-card {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <div class="login-container">
            <div class="logo">üè†</div>
            <h1>Nyx Property Management</h1>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="sn_apt_management@outlook.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <div style="margin-bottom: 15px;">
                <button type="button" onclick="fillAdminCredentials()" style="background: #007bff; color: white; padding: 8px 12px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">Fill Admin</button>
                <button type="button" onclick="fillNinaCredentials()" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">Fill Nina</button>
            </div>
            <button class="btn" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Quick Dashboard -->
    <div id="quickDashboard" class="quick-dashboard">
        <div class="compact-metrics">
            <div class="compact-metric occupancy" onclick="showTab('reports')">
                <div>üìä <strong>Occupancy Rate</strong></div>
                <div style="font-size: 24px; color: #28a745;">96%</div>
                <div style="font-size: 12px; color: #6c757d;">Target: 90%</div>
            </div>
            <div class="compact-metric revenue" onclick="showTab('financial')">
                <div>üí∞ <strong>Monthly Revenue</strong></div>
                <div style="font-size: 24px; color: #007bff;">R58,145</div>
                <div style="font-size: 12px; color: #6c757d;">Goal: R60,000</div>
            </div>
            <div class="compact-metric checkins" onclick="showTab('checkin')">
                <div>‚úÖ <strong>Today</strong></div>
                <div style="font-size: 24px; color: #17a2b8;">3 Check-ins | 2 Check-outs</div>
                <div style="font-size: 12px; color: #6c757d;">Next: 2pm arrival</div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardSection" class="dashboard-section">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <span>üè†</span>
                <h2>Property Management Dashboard</h2>
                <span>üëã Welcome, Nicole!</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('properties')">üè† Properties</button>
            <button class="nav-tab" onclick="showTab('bookings')">üìÖ Bookings</button>
            <button class="nav-tab" onclick="showTab('knowledge')">üìö Knowledge Base</button>
        </div>

        <!-- Properties Tab -->
        <div id="properties-tab" class="tab-content active">
            <h2>üè† Property Overview</h2>
            <div class="property-card">
                <h3>üåü Speranta Property</h3>
                <p><strong>Address:</strong> 35 Athens Road, Blouberg</p>
                <p><strong>Type:</strong> 2BR Apartment | Max 4 Guests</p>
                <p><strong>WiFi:</strong> SperantaGuest2024 | <strong>Gate Code:</strong> 7481</p>
                <p><strong>Status:</strong> ‚úÖ Active</p>
            </div>
            <div class="property-card">
                <h3>üè° TV House Property</h3>
                <p><strong>Address:</strong> 110 Athens Road, Tableview</p>
                <p><strong>Type:</strong> 3BR House | Max 6 Guests</p>
                <p><strong>WiFi:</strong> TVHouseGuest2024 | <strong>Gate Code:</strong> 2847</p>
                <p><strong>Status:</strong> ‚úÖ Active</p>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div id="bookings-tab" class="tab-content">
            <h2>üìÖ Real Booking Data Integration</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>üîß Enhanced Debugging System</h3>
                <p>‚úÖ Base64 iCal decoding implemented</p>
                <p>‚úÖ CORS proxy fix applied (/get endpoint)</p>
                <p>‚úÖ Comprehensive logging with emoji indicators</p>
                <p>‚úÖ Production-ready code committed</p>
                <button onclick="fetchRealBookingData()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px;">üîÑ Load Real Booking Data</button>
                <button onclick="runDiagnosticCheck()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px; margin-left: 10px;">üîç Diagnostic Check</button>
                <div id="booking-status" style="margin-top: 10px; font-weight: bold;">Ready to load real data</div>
                <div id="diagnostic-results" style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; display: none;">
                    <h5>üîç Diagnostic Results</h5>
                    <div id="diagnostic-content"></div>
                </div>
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4>üì° iCal Feed Integration Status</h4>
                <p>üü¢ <strong>Speranta:</strong> 4 platforms configured</p>
                <p>üü¢ <strong>TV House:</strong> 3 platforms configured</p>
                <p>üìù Real booking data will replace test data automatically</p>
            </div>

            <!-- Real Bookings Display -->
            <div id="bookings-display" style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <h3>üìÖ Current Bookings</h3>
                <div id="bookings-list" style="margin-top: 15px;">
                    <p style="color: #6c757d; font-style: italic;">Load real booking data to see current reservations...</p>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üß† Knowledge Base & Guest Information</h2>
                <button class="btn" onclick="openAddArticleModal()" style="width: auto; padding: 8px 16px;">+ Add Article</button>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <input type="text" placeholder="Search articles..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <select style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option>All Categories</option>
                    <option>Property Info</option>
                    <option>Guest Instructions</option>
                    <option>Emergency Procedures</option>
                    <option>Local Area</option>
                    <option>Troubleshooting</option>
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
                <!-- Categories Sidebar -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; height: fit-content;">
                    <h3 style="margin-bottom: 15px;">Categories</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('property')">üè† Property Information</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('guest')">üë• Guest Instructions</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('emergency')">üö® Emergency Procedures</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('local')">üìç Local Area Guide</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('troubleshoot')">üîß Troubleshooting</li>
                    </ul>
                </div>
                
                <!-- Articles Content -->
                <div style="display: grid; gap: 15px;">
                    <div class="article-card" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin-bottom: 5px;">üì∂ WiFi & Internet Access</h4>
                                <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Property Info</span>
                            </div>
                            <button onclick="editArticle(1)" style="background: none; border: none; cursor: pointer; font-size: 16px;">‚úèÔ∏è</button>
                        </div>
                        <div style="line-height: 1.6;">
                            <p><strong>Speranta WiFi:</strong></p>
                            <p>‚Ä¢ Network: SperantaGuest2024</p>
                            <p>‚Ä¢ Password: SperantaGuest2024</p>
                            <p><strong>TV House WiFi:</strong></p>
                            <p>‚Ä¢ Network: TVHouseGuest2024</p>
                            <p>‚Ä¢ Password: TVHouseGuest2024</p>
                            <p><strong>If having connection issues:</strong></p>
                            <p>1. Restart your device's WiFi</p>
                            <p>2. Router reset button is in kitchen cabinet</p>
                            <p>3. Contact Nina: +27 123 456 789</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // ENHANCED DEBUGGING SYSTEM
        // ===========================================
        
        const PROPERTY_ICAL_FEEDS = {
            speranta: {
                name: 'Speranta (35 Athens Road Blouberg)',
                feeds: {
                    booking: 'https://ical.booking.com/v1/export?t=8123e217-45b4-403d-8fa0-9dcc65c26800',
                    lekkeslaap: 'https://www.lekkeslaap.co.za/suppliers/icalendar.ics?t=bXEzOHNicTJQT3Nkd1dHb1ZSaXhRUT09',
                    fewo: 'http://www.fewo-direkt.de/icalendar/12b719114ecd42adab4e9ade2d2458e6.ics?nonTentative',
                    airbnb: 'https://www.airbnb.com/calendar/ical/1237076374831130516.ics?s=01582d0497e99114aa6013156146cea4&locale=en-GB'
                }
            },
            tvhouse: {
                name: 'TV House (110 Athens Road Tableview)',
                feeds: {
                    booking: 'https://ical.booking.com/v1/export?t=ea29c451-4d0b-4fa4-b7a8-e879a33a8940',
                    lekkeslaap: 'https://www.lekkeslaap.co.za/suppliers/icalendar.ics?t=QzZ2aFlFVHhxYnoxdGRVL3ZwelRGUT09',
                    airbnb: 'https://www.airbnb.com/calendar/ical/1402174824640448492.ics?s=373c5a71c137230a72f928e88728dcf3&locale=en-GB'
                }
            }
        };

        let globalBookingData = { speranta: [], tvhouse: [], lastUpdated: null };
        let historicalBookingData = []; // Persistent storage for all historical bookings

        // Load historical data from localStorage
        function loadHistoricalData() {
            try {
                const stored = localStorage.getItem('nyxPropertyBookingHistory');
                if (stored) {
                    historicalBookingData = JSON.parse(stored);
                    console.log(`üìú Loaded ${historicalBookingData.length} historical bookings from storage`);
                }
            } catch (error) {
                console.error('Error loading historical data:', error);
                historicalBookingData = [];
            }
        }

        // Save booking data to localStorage
        function saveBookingToHistory(booking) {
            // Create a unique ID for the booking
            const bookingId = `${booking.property}-${booking.platform}-${booking.start}-${booking.end}`;
            
            // Check if booking already exists
            const exists = historicalBookingData.some(stored => 
                stored.id === bookingId || 
                (stored.property === booking.property && 
                 stored.platform === booking.platform && 
                 stored.start === booking.start && 
                 stored.end === booking.end)
            );
            
            if (!exists) {
                const bookingRecord = {
                    ...booking,
                    id: bookingId,
                    savedAt: new Date().toISOString(),
                    status: getBookingStatus(booking)
                };
                
                historicalBookingData.push(bookingRecord);
                
                // Keep only last 500 bookings to prevent localStorage overflow
                if (historicalBookingData.length > 500) {
                    historicalBookingData = historicalBookingData.slice(-500);
                }
                
                // Save to localStorage
                try {
                    localStorage.setItem('nyxPropertyBookingHistory', JSON.stringify(historicalBookingData));
                    console.log(`üíæ Saved booking: ${booking.summary} (${booking.property} - ${booking.platform})`);
                } catch (error) {
                    console.error('Error saving booking to history:', error);
                }
            }
        }

        // Determine booking status
        function getBookingStatus(booking) {
            const today = new Date();
            const startDate = new Date(booking.start);
            const endDate = new Date(booking.end);
            
            if (startDate <= today && endDate >= today) {
                return 'current';
            } else if (startDate > today) {
                return 'upcoming';
            } else {
                return 'past';
            }
        }

        // Save all current bookings to history
        function saveAllBookingsToHistory() {
            const allBookings = [
                ...globalBookingData.speranta.map(b => ({...b, property: 'Speranta'})),
                ...globalBookingData.tvhouse.map(b => ({...b, property: 'TV House'}))
            ];
            
            allBookings.forEach(booking => saveBookingToHistory(booking));
            console.log(`üì¶ Processed ${allBookings.length} bookings for historical storage`);
        }

        // Enhanced iCal Parser with Comprehensive Debugging
        function parseICalData(icalText, platform) {
            console.log(`üîß parseICalData called for ${platform}`);
            console.log(`üìù Input text length: ${icalText.length}`);
            console.log(`üìÑ First 500 chars: ${icalText.substring(0, 500)}`);
            
            const events = [];
            const lines = icalText.split('\n');
            let currentEvent = {};
            let inEvent = false;
            let eventCount = 0;
            let vcalendarFound = false;

            console.log(`üìã Processing ${lines.length} lines`);

            // Check for VCALENDAR structure
            for (let i = 0; i < Math.min(50, lines.length); i++) {
                const line = lines[i].trim();
                if (line === 'BEGIN:VCALENDAR') {
                    vcalendarFound = true;
                    console.log(`üìÖ Found VCALENDAR at line ${i + 1}`);
                    break;
                }
            }

            if (!vcalendarFound) {
                console.log(`‚ö†Ô∏è No VCALENDAR found in first 50 lines - this might not be a valid iCal file`);
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === 'BEGIN:VEVENT') {
                    console.log(`üéØ Found BEGIN:VEVENT at line ${i + 1}`);
                    inEvent = true;
                    currentEvent = { platform: platform };
                    eventCount++;
                } else if (line === 'END:VEVENT' && inEvent) {
                    console.log(`üèÅ Found END:VEVENT at line ${i + 1} for event ${eventCount}`);
                    console.log(`üîç Event data:`, currentEvent);
                    
                    if (currentEvent.start && currentEvent.end) {
                        console.log(`‚úÖ Valid event: ${currentEvent.summary} from ${currentEvent.start} to ${currentEvent.end}`);
                        events.push(currentEvent);
                    } else {
                        console.log(`‚ùå Invalid event (missing dates): start=${currentEvent.start}, end=${currentEvent.end}`);
                        console.log(`üîç Raw event object:`, currentEvent);
                    }
                    currentEvent = {};
                    inEvent = false;
                } else if (inEvent) {
                    if (line.startsWith('DTSTART')) {
                        const fullLine = line;
                        let dateStr = '';
                        if (line.includes(':')) {
                            dateStr = line.split(':').slice(1).join(':');
                        } else if (line.includes('=')) {
                            dateStr = line.split('=').pop();
                        }
                        console.log(`üìÖ DTSTART line: "${fullLine}" ‚Üí extracted: "${dateStr}"`);
                        currentEvent.start = parseICalDate(dateStr);
                        console.log(`üìÖ DTSTART parsed: ${dateStr} ‚Üí ${currentEvent.start}`);
                    } else if (line.startsWith('DTEND')) {
                        const fullLine = line;
                        let dateStr = '';
                        if (line.includes(':')) {
                            dateStr = line.split(':').slice(1).join(':');
                        } else if (line.includes('=')) {
                            dateStr = line.split('=').pop();
                        }
                        console.log(`üìÖ DTEND line: "${fullLine}" ‚Üí extracted: "${dateStr}"`);
                        currentEvent.end = parseICalDate(dateStr);
                        console.log(`üìÖ DTEND parsed: ${dateStr} ‚Üí ${currentEvent.end}`);
                    } else if (line.startsWith('SUMMARY')) {
                        const summary = line.includes(':') ? line.split(':').slice(1).join(':') : 'Booking';
                        currentEvent.summary = summary;
                        console.log(`üìù SUMMARY: ${summary}`);
                    } else if (line.startsWith('DESCRIPTION')) {
                        const description = line.includes(':') ? line.split(':').slice(1).join(':') : '';
                        currentEvent.description = description;
                        console.log(`üìÑ DESCRIPTION: ${description}`);
                    } else if (line.startsWith('ORGANIZER')) {
                        const organizer = line.includes(':') ? line.split(':').slice(1).join(':') : '';
                        currentEvent.organizer = organizer;
                        console.log(`üë§ ORGANIZER: ${organizer}`);
                    } else if (line.startsWith('ATTENDEE')) {
                        const attendee = line.includes(':') ? line.split(':').slice(1).join(':') : '';
                        if (!currentEvent.attendees) currentEvent.attendees = [];
                        currentEvent.attendees.push(attendee);
                        console.log(`üë• ATTENDEE: ${attendee}`);
                    }
                }
            }
            
            console.log(`üéä parseICalData finished: Found ${events.length} valid events out of ${eventCount} VEVENT blocks`);
            console.log(`üìä Summary: VCALENDAR=${vcalendarFound}, VEVENT blocks=${eventCount}, Valid events=${events.length}`);
            
            if (eventCount > 0 && events.length === 0) {
                console.log(`‚ö†Ô∏è WARNING: Found ${eventCount} VEVENT blocks but 0 valid events - likely date parsing issues`);
            }
            
            return events;
        }

        function parseICalDate(dateString) {
            console.log(`üïí Parsing date: "${dateString}"`);
            
            if (dateString.length === 8) {
                const parsed = new Date(
                    dateString.substring(0, 4),
                    dateString.substring(4, 6) - 1,
                    dateString.substring(6, 8)
                );
                console.log(`üìÖ Parsed YYYYMMDD format: ${dateString} ‚Üí ${parsed}`);
                return parsed;
            } else if (dateString.includes('T')) {
                const date = dateString.split('T')[0];
                const parsed = new Date(
                    date.substring(0, 4),
                    date.substring(4, 6) - 1,
                    date.substring(6, 8)
                );
                console.log(`üìÖ Parsed datetime format: ${dateString} ‚Üí ${parsed}`);
                return parsed;
            }
            
            const parsed = new Date(dateString);
            console.log(`üìÖ Parsed generic format: ${dateString} ‚Üí ${parsed}`);
            return parsed;
        }

        // Enhanced Data Fetching with Advanced Debugging
        async function fetchRealBookingData() {
            console.log('üî• FETCHING REAL BOOKING DATA...');
            const statusElement = document.getElementById('booking-status');
            if (statusElement) {
                statusElement.textContent = 'Loading real booking data...';
                statusElement.style.color = '#ffc107';
            }

            try {
                const allBookings = { speranta: [], tvhouse: [] };
                const detailedResults = [];
                console.log('üìã iCal feeds configured:', PROPERTY_ICAL_FEEDS);

                for (const [propertyKey, property] of Object.entries(PROPERTY_ICAL_FEEDS)) {
                    console.log(`üìç Fetching bookings for ${property.name}`);
                    
                    for (const [platform, feedUrl] of Object.entries(property.feeds)) {
                        try {
                            console.log(`üåê Fetching ${platform} data for ${propertyKey}`);
                            console.log(`üì° URL: ${feedUrl}`);
                            
                            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(feedUrl);
                            console.log(`üîÑ Using proxy: ${proxyUrl}`);
                            
                            // Add timeout and retry for problematic feeds
                            const fetchWithTimeout = async (url, timeout = 10000) => {
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), timeout);
                                
                                try {
                                    const response = await fetch(url, { signal: controller.signal });
                                    clearTimeout(timeoutId);
                                    return response;
                                } catch (error) {
                                    clearTimeout(timeoutId);
                                    throw error;
                                }
                            };
                            
                            const response = await fetchWithTimeout(proxyUrl);
                            console.log(`üìä Response status: ${response.status} ${response.statusText}`);
                            
                            const jsonData = await response.json();
                            console.log(`üì¶ JSON response keys: ${Object.keys(jsonData)}`);
                            console.log(`üì¶ JSON status info:`, jsonData.status || 'No status field');
                            
                            let icalData = jsonData.contents || '';
                            
                            console.log(`üì¶ Raw data type: ${typeof icalData}, length: ${icalData.length}`);
                            console.log(`üìù Raw data preview (first 500 chars): ${icalData.substring(0, 500)}`);
                            
                            // Log more details for debugging
                            detailedResults.push({
                                property: propertyKey,
                                platform: platform,
                                responseStatus: response.status,
                                dataLength: icalData.length,
                                hasVcalendar: icalData.includes('BEGIN:VCALENDAR'),
                                hasVevent: icalData.includes('BEGIN:VEVENT'),
                                preview: icalData.substring(0, 200)
                            });

                            // Handle base64 encoded content - enhanced detection
                            let processedData = icalData;
                            
                            // Check for base64 encoded iCal data (multiple formats)
                            if (icalData.startsWith('data:text/calendar;base64,') || 
                                icalData.startsWith('data:text/calendar;charset=UTF-8;base64,') ||
                                icalData.startsWith('data:text/calendar;charset=utf-8;base64,')) {
                                
                                console.log('üîì Decoding base64 iCal content...');
                                const base64Content = icalData.split('base64,')[1];
                                console.log(`üîç Base64 content length: ${base64Content ? base64Content.length : 'not found'}`);
                                
                                try {
                                    if (base64Content) {
                                        processedData = atob(base64Content);
                                        console.log('‚úÖ Decoded iCal length:', processedData.length);
                                        console.log('üìÑ Decoded preview:', processedData.substring(0, 300));
                                        
                                        // Special logging for TV House Airbnb
                                        if (propertyKey === 'tvhouse' && platform === 'airbnb') {
                                            console.log('üéØ TV HOUSE AIRBNB DECODED CONTENT:');
                                            console.log(processedData);
                                        }
                                    } else {
                                        console.error('‚ùå No base64 content found after split');
                                    }
                                } catch (decodeError) {
                                    console.error('‚ùå Base64 decode failed:', decodeError);
                                    continue;
                                }
                            }

                            // More thorough validation with enhanced HTML detection
                            const hasValidCalendar = processedData && processedData.length > 50 && (
                                processedData.includes('BEGIN:VCALENDAR') || 
                                processedData.includes('VEVENT') ||
                                processedData.includes('DTSTART') ||
                                processedData.includes('DTEND')
                            ) && !processedData.includes('<html>') && !processedData.includes('<!DOCTYPE');

                            // Check if it's an HTML error page instead of calendar data
                            const isErrorPage = processedData.includes('<html>') || 
                                               processedData.includes('<!DOCTYPE') || 
                                               processedData.includes('<head>') ||
                                               processedData.toLowerCase().includes('error') ||
                                               processedData.toLowerCase().includes('not found') ||
                                               processedData.toLowerCase().includes('access denied');

                            if (hasValidCalendar) {
                                console.log(`üéØ Processing iCal data for ${platform} on ${propertyKey}`);
                                console.log(`üìã Calendar content indicators: VCALENDAR=${processedData.includes('BEGIN:VCALENDAR')}, VEVENT=${processedData.includes('BEGIN:VEVENT')}, DTSTART=${processedData.includes('DTSTART')}`);
                                
                                const events = parseICalData(processedData, platform);
                                console.log(`üéâ parseICalData returned ${events.length} events for ${platform}`);
                                
                                if (events.length > 0) {
                                    events.forEach((event, idx) => {
                                        console.log(`üìÖ Event ${idx + 1}: "${event.summary}" from ${new Date(event.start).toDateString()} to ${new Date(event.end).toDateString()}`);
                                    });
                                    allBookings[propertyKey] = allBookings[propertyKey].concat(events);
                                } else {
                                    console.log(`‚ö†Ô∏è No events parsed from ${platform} for ${propertyKey} despite valid calendar markers`);
                                }
                            } else if (isErrorPage) {
                                console.log(`üö´ HTML error page detected from ${platform} for ${propertyKey} instead of iCal data`);
                                console.log(`üìÑ Error page preview: ${processedData.substring(0, 300)}`);
                            } else {
                                console.log(`‚ùå No valid iCal data from ${platform} for ${propertyKey}`);
                                console.log(`üîç Data analysis: length=${processedData.length}, starts with: "${processedData.substring(0, 100)}"`);
                            }
                        } catch (error) {
                            console.error(`üí• Error fetching ${platform} data for ${propertyKey}:`, error);
                            detailedResults.push({
                                property: propertyKey,
                                platform: platform,
                                error: error.message,
                                responseStatus: 'ERROR'
                            });
                        }
                    }
                }

                // Enhanced summary logging
                console.log('üìä DETAILED FETCH RESULTS:');
                console.table(detailedResults);

                // Load historical data first
                loadHistoricalData();

                globalBookingData = {
                    speranta: allBookings.speranta,
                    tvhouse: allBookings.tvhouse,
                    lastUpdated: new Date()
                };

                // Save all bookings to historical storage
                saveAllBookingsToHistory();

                const totalBookings = allBookings.speranta.length + allBookings.tvhouse.length;
                console.log(`üéØ TOTAL REAL BOOKINGS LOADED: ${totalBookings}`);
                console.log(`üìà Speranta bookings: ${allBookings.speranta.length}`);
                console.log(`üìà TV House bookings: ${allBookings.tvhouse.length}`);

                // Show summary in status
                const summary = detailedResults.map(r => 
                    `${r.platform}: ${r.error ? 'ERROR' : (r.hasVevent ? 'HAS_EVENTS' : 'NO_EVENTS')}`
                ).join(', ');

                if (statusElement) {
                    if (totalBookings > 0) {
                        statusElement.innerHTML = `‚úÖ ${totalBookings} real bookings loaded! Last updated: ${new Date().toLocaleTimeString()}`;
                        statusElement.style.color = '#28a745';
                        
                        // Display the bookings
                        displayBookings(allBookings);
                    } else {
                        statusElement.innerHTML = `‚ö†Ô∏è Connected (${detailedResults.length} feeds checked) but no bookings found. ${summary}. Last checked: ${new Date().toLocaleTimeString()}`;
                        statusElement.style.color = '#ffc107';
                    }
                }

                console.log('üöÄ Enhanced debugging system working correctly. Check console for detailed analysis.');
                
            } catch (error) {
                console.error('üí• Error fetching booking data:', error);
                if (statusElement) {
                    statusElement.innerHTML = `‚ùå Error loading booking data: ${error.message}`;
                    statusElement.style.color = '#dc3545';
                }
            }
        }

        // Display bookings in a nice format
        function displayBookings(bookings) {
            const bookingsListElement = document.getElementById('bookings-list');
            if (!bookingsListElement) return;

            let html = '';
            const today = new Date();

            // Combine all bookings and sort by date
            const allBookings = [
                ...bookings.speranta.map(b => ({...b, property: 'Speranta'})),
                ...bookings.tvhouse.map(b => ({...b, property: 'TV House'}))
            ].sort((a, b) => new Date(a.start) - new Date(b.start));

            if (allBookings.length === 0) {
                html = '<p style="color: #6c757d; font-style: italic;">No bookings found in the selected time range.</p>';
            } else {
                // Current bookings (happening now)
                const currentBookings = allBookings.filter(booking => {
                    const startDate = new Date(booking.start);
                    const endDate = new Date(booking.end);
                    return startDate <= today && endDate >= today;
                });

                // Upcoming bookings (next 60 days for better visibility)
                const upcomingBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.start);
                    const sixtyDaysFromNow = new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000);
                    return bookingDate > today && bookingDate <= sixtyDaysFromNow;
                });

                // All future bookings beyond 60 days
                const futureBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.start);
                    const sixtyDaysFromNow = new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000);
                    return bookingDate > sixtyDaysFromNow;
                });

                // Past bookings (completed)
                const pastBookings = allBookings.filter(booking => {
                    const endDate = new Date(booking.end);
                    return endDate < today;
                });

                if (currentBookings.length > 0) {
                    html += '<h4 style="color: #28a745; margin-bottom: 15px;">üî¥ Current Bookings (Active Now)</h4>';
                    currentBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms
                        let guestName = 'Guest';
                        let bookingRef = '';
                        let platformColor = '#17a2b8'; // Default color
                        
                        if (booking.platform === 'lekkeslaap') {
                            // LekkeSlaap format: "Reference: LS-5FZ37J\nView at: https://..."
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                bookingRef = refMatch[1];
                                cleanSummary = `LekkeSlaap Booking ${bookingRef}`;
                            }
                            platformColor = '#28a745'; // Green for LekkeSlaap
                        } else if (booking.platform === 'booking') {
                            // Booking.com format might contain guest names or be "CLOSED - Not available"
                            if (cleanSummary.includes('CLOSED')) {
                                cleanSummary = 'Property Blocked (Maintenance/Personal Use)';
                                guestName = 'BLOCKED';
                            } else {
                                // Extract guest name if present
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+\s+[A-Z][a-z]+)/);
                                if (nameMatch) {
                                    guestName = nameMatch[1];
                                    cleanSummary = `Booking.com - ${guestName}`;
                                }
                            }
                            platformColor = '#007bff'; // Blue for Booking.com
                        } else if (booking.platform === 'airbnb') {
                            // Airbnb usually shows guest first name
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                guestName = nameMatch[1];
                                cleanSummary = `Airbnb - ${guestName}`;
                            }
                            platformColor = '#FF1493'; // Airbnb red
                        } else if (booking.platform === 'fewo') {
                            platformColor = '#ffc107'; // Yellow for FeWo
                        }
                        
                        // Truncate if too long
                        if (cleanSummary.length > 60) {
                            cleanSummary = cleanSummary.substring(0, 60) + '...';
                        }
                        
                        html += `
                            <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">üè† ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">üì± ${booking.platform.toUpperCase()}</span>
                                        </div>
                                        <h5 style="color: #155724; margin-bottom: 8px; font-size: 16px;">${cleanSummary}</h5>
                                        <div style="color: #155724; font-size: 14px; line-height: 1.5;">
                                            <div>üìÖ <strong>Check-in:</strong> ${startDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</div>
                                            <div>üìÖ <strong>Check-out:</strong> ${endDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</div>
                                            <div>‚è∞ <strong>Days remaining:</strong> ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <span style="background: #28a745; color: white; padding: 8px 16px; border-radius: 25px; font-size: 14px; font-weight: bold; display: inline-block;">üü¢ ACTIVE</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (upcomingBookings.length > 0) {
                    html += '<h4 style="color: #007bff; margin-bottom: 15px; margin-top: 25px;">üìÖ Upcoming Bookings (Next 60 Days)</h4>';
                    upcomingBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms
                        let guestName = 'Guest';
                        let bookingRef = '';
                        let platformColor = '#17a2b8'; // Default color
                        
                        if (booking.platform === 'lekkeslaap') {
                            // LekkeSlaap format: "Reference: LS-5FZ37J\nView at: https://..."
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                bookingRef = refMatch[1];
                                cleanSummary = `LekkeSlaap Booking ${bookingRef}`;
                            }
                            platformColor = '#28a745'; // Green for LekkeSlaap
                        } else if (booking.platform === 'booking') {
                            // Booking.com format might contain guest names or be "CLOSED - Not available"
                            if (cleanSummary.includes('CLOSED')) {
                                cleanSummary = 'Property Blocked (Maintenance/Personal Use)';
                                guestName = 'BLOCKED';
                            } else {
                                // Extract guest name if present
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+\s+[A-Z][a-z]+)/);
                                if (nameMatch) {
                                    guestName = nameMatch[1];
                                    cleanSummary = `Booking.com - ${guestName}`;
                                }
                            }
                            platformColor = '#007bff'; // Blue for Booking.com
                        } else if (booking.platform === 'airbnb') {
                            // Airbnb usually shows guest first name
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                guestName = nameMatch[1];
                                cleanSummary = `Airbnb - ${guestName}`;
                            }
                            platformColor = '#FF1493'; // Airbnb red
                        } else if (booking.platform === 'fewo') {
                            platformColor = '#ffc107'; // Yellow for FeWo
                        }
                        
                        // Truncate if too long
                        if (cleanSummary.length > 60) {
                            cleanSummary = cleanSummary.substring(0, 60) + '...';
                        }
                        
                        // Color coding for urgency
                        let urgencyColor = '#007bff';
                        let urgencyText = 'üîµ UPCOMING';
                        if (daysUntil <= 3) {
                            urgencyColor = '#dc3545';
                            urgencyText = 'üî¥ URGENT';
                        } else if (daysUntil <= 7) {
                            urgencyColor = '#ffc107';
                            urgencyText = 'üü° SOON';
                        }
                        
                        html += `
                            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${urgencyColor};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span style="background: ${urgencyColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">üè† ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">üì± ${booking.platform.toUpperCase()}</span>
                                        </div>
                                        <h5 style="color: #495057; margin-bottom: 8px; font-size: 16px;">${cleanSummary}</h5>
                                        <div style="color: #6c757d; font-size: 14px; line-height: 1.5;">
                                            <div>üìÖ <strong>Check-in:</strong> ${startDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</div>
                                            <div>üìÖ <strong>Check-out:</strong> ${endDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</div>
                                            <div>‚è∞ <strong>Arrival in:</strong> ${daysUntil} day${daysUntil !== 1 ? 's' : ''} | <strong>Duration:</strong> ${duration} night${duration !== 1 ? 's' : ''}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <span style="background: ${urgencyColor}; color: white; padding: 8px 16px; border-radius: 25px; font-size: 14px; font-weight: bold; display: inline-block;">${urgencyText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (futureBookings.length > 0) {
                    html += `<h4 style="color: #6f42c1; margin-bottom: 15px; margin-top: 25px;">üîÆ Future Bookings (${futureBookings.length} bookings beyond 60 days)</h4>`;
                    html += `<div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p style="color: #6c757d; margin: 0;">Click "Show Future Bookings" to see all ${futureBookings.length} bookings scheduled beyond the next 60 days.</p>
                        <button onclick="toggleFutureBookings()" id="toggle-future-btn" style="background: #6f42c1; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Show Future Bookings</button>
                    </div>`;
                    
                    html += '<div id="future-bookings" style="display: none;">';
                    futureBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        // Platform-specific colors
                        let platformColor = '#6c757d'; // Default grey
                        if (booking.platform === 'airbnb') platformColor = '#FF1493'; // Airbnb signature pink
                        else if (booking.platform === 'booking') platformColor = '#007bff';
                        else if (booking.platform === 'lekkeslaap') platformColor = '#28a745';
                        else if (booking.platform === 'fewo') platformColor = '#ffc107';
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms
                        if (booking.platform === 'lekkeslaap') {
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                cleanSummary = `LekkeSlaap ${refMatch[1]}`;
                            }
                        } else if (booking.platform === 'booking') {
                            if (cleanSummary.includes('CLOSED')) {
                                cleanSummary = 'Property Blocked';
                            } else {
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+\s+[A-Z][a-z]+)/);
                                if (nameMatch) {
                                    cleanSummary = `Booking.com - ${nameMatch[1]}`;
                                }
                            }
                        } else if (booking.platform === 'airbnb') {
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                cleanSummary = `Airbnb - ${nameMatch[1]}`;
                            }
                        }
                        
                        if (cleanSummary.length > 40) {
                            cleanSummary = cleanSummary.substring(0, 40) + '...';
                        }
                        
                        html += `
                            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px; opacity: 0.8;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                            <span style="background: #6f42c1; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">üè† ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">üì± ${booking.platform.toUpperCase()}</span>
                                        </div>
                                        <strong style="color: #495057; font-size: 14px;">${cleanSummary}</strong>
                                        <div style="color: #6c757d; font-size: 12px;">
                                            üìÖ ${startDate.toLocaleDateString('en-GB')} - ${endDate.toLocaleDateString('en-GB')} | ‚è∞ ${daysUntil} days away
                                        </div>
                                    </div>
                                    <span style="background: #6f42c1; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px;">üîÆ FUTURE</span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Past bookings section
                if (pastBookings.length > 0) {
                    html += `<h4 style="color: #6c757d; margin-bottom: 15px; margin-top: 25px;">üìú Past Bookings (${pastBookings.length} completed)</h4>`;
                    html += `<div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p style="color: #6c757d; margin: 0;">üéØ <strong>Historical Data Available!</strong> Found ${pastBookings.length} past bookings. Click to view completed stays.</p>
                        <button onclick="togglePastBookings()" id="toggle-past-btn" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Show Past Bookings</button>
                    </div>`;
                    
                    html += '<div id="past-bookings" style="display: none;">';
                    // Sort past bookings by end date (most recent first)
                    pastBookings.sort((a, b) => new Date(b.end) - new Date(a.end));
                    
                    pastBookings.forEach(booking => {
                        const startDate = new Date(booking.start);
                        const endDate = new Date(booking.end);
                        const daysSince = Math.ceil((today - endDate) / (1000 * 60 * 60 * 24));
                        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        // Platform-specific colors
                        let platformColor = '#495057'; // Default dark grey for past bookings
                        if (booking.platform === 'airbnb') platformColor = '#CC484D'; // Darker Airbnb red
                        else if (booking.platform === 'booking') platformColor = '#0056B3'; // Darker booking.com blue
                        else if (booking.platform === 'lekkeslaap') platformColor = '#1E7E34'; // Darker green
                        else if (booking.platform === 'fewo') platformColor = '#E0A800'; // Darker yellow
                        
                        // Clean up the summary text and extract guest info
                        let cleanSummary = booking.summary || 'Booking';
                        cleanSummary = cleanSummary.replace(/\\n/g, ' ').replace(/\n/g, ' ');
                        
                        // Extract guest name and reference from different platforms
                        if (booking.platform === 'lekkeslaap') {
                            const refMatch = cleanSummary.match(/Reference:\s*(LS-[A-Z0-9]+)/);
                            if (refMatch) {
                                cleanSummary = `LekkeSlaap ${refMatch[1]}`;
                            }
                        } else if (booking.platform === 'booking') {
                            if (cleanSummary.includes('CLOSED')) {
                                cleanSummary = 'Property Blocked';
                            } else {
                                const nameMatch = cleanSummary.match(/([A-Z][a-z]+\s+[A-Z][a-z]+)/);
                                if (nameMatch) {
                                    cleanSummary = `Booking.com - ${nameMatch[1]}`;
                                }
                            }
                        } else if (booking.platform === 'airbnb') {
                            const nameMatch = cleanSummary.match(/([A-Z][a-z]+)/);
                            if (nameMatch) {
                                cleanSummary = `Airbnb - ${nameMatch[1]}`;
                            }
                        }
                        
                        if (cleanSummary.length > 40) {
                            cleanSummary = cleanSummary.substring(0, 40) + '...';
                        }
                        
                        html += `
                            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; opacity: 0.7;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                            <span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">üè† ${booking.property}</span>
                                            <span style="background: ${platformColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">üì± ${booking.platform.toUpperCase()}</span>
                                        </div>
                                        <strong style="color: #495057; font-size: 14px;">${cleanSummary}</strong>
                                        <div style="color: #6c757d; font-size: 12px;">
                                            üìÖ ${startDate.toLocaleDateString('en-GB')} - ${endDate.toLocaleDateString('en-GB')} | üèÅ ${daysSince} days ago | üåô ${duration} nights
                                        </div>
                                    </div>
                                    <span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px;">üìú COMPLETED</span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    // Debug info when no past bookings found
                    html += `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; margin-top: 25px;">
                            <h6 style="color: #495057; margin-bottom: 10px;">üìú Historical Booking Analysis</h6>
                            <p style="color: #6c757d; font-size: 14px; margin: 0;">
                                ‚ùå No past bookings detected in current feed data.<br>
                                üí° <strong>Expected behavior:</strong> Most platforms (Airbnb, Booking.com, FeWo) filter out past bookings from iCal feeds.<br>
                                ‚úÖ LekkeSlaap may include some historical data.<br>
                                üîß For complete booking history, consider manual data import or local persistence.
                            </p>
                        </div>
                    `;
                }

                // Enhanced Summary stats
                html += `
                    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f1f3f4 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                        <h5 style="color: #495057; margin-bottom: 15px; text-align: center;">üìä Booking Dashboard Summary</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #28a745;">${currentBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">ACTIVE NOW</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #007bff;">${upcomingBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">NEXT 60 DAYS</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #6f42c1;">${futureBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">FUTURE</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #6c757d;">${pastBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">COMPLETED</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 28px; font-weight: bold; color: #17a2b8;">${allBookings.length}</div>
                                <div style="font-size: 12px; color: #6c757d; font-weight: 500;">TOTAL LOADED</div>
                            </div>
                        </div>
                        
                        <!-- Platform Breakdown -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                            <h6 style="color: #495057; margin-bottom: 10px; text-align: center;">üì± Platform Breakdown</h6>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                ${getPlatformStats(allBookings)}
                            </div>
                        </div>
                    </div>
                `;
            }

            bookingsListElement.innerHTML = html;
        }

        // Get platform statistics
        function getPlatformStats(bookings) {
            const platforms = {};
            bookings.forEach(booking => {
                platforms[booking.platform] = (platforms[booking.platform] || 0) + 1;
            });
            
            return Object.entries(platforms).map(([platform, count]) => {
                const colors = {
                    booking: '#007bff',
                    airbnb: '#FF1493',
                    lekkeslaap: '#28a745',
                    fewo: '#ffc107'
                };
                const color = colors[platform.toLowerCase()] || '#6c757d';
                
                return `
                    <div style="background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: ${color};">${count}</div>
                        <div style="font-size: 10px; color: #6c757d; text-transform: uppercase;">${platform}</div>
                    </div>
                `;
            }).join('');
        }

        // Toggle future bookings visibility
        function toggleFutureBookings() {
            const futureDiv = document.getElementById('future-bookings');
            const toggleBtn = document.getElementById('toggle-future-btn');
            
            if (futureDiv.style.display === 'none') {
                futureDiv.style.display = 'block';
                toggleBtn.textContent = 'Hide Future Bookings';
            } else {
                futureDiv.style.display = 'none';
                toggleBtn.textContent = 'Show Future Bookings';
            }
        }

        // Toggle past bookings visibility
        function togglePastBookings() {
            const pastDiv = document.getElementById('past-bookings');
            const toggleBtn = document.getElementById('toggle-past-btn');
            
            if (pastDiv && pastDiv.style.display === 'none') {
                pastDiv.style.display = 'block';
                toggleBtn.textContent = 'Hide Past Bookings';
            } else if (pastDiv) {
                pastDiv.style.display = 'none';
                toggleBtn.textContent = 'Show Past Bookings';
            }
        }

        // Enhanced Diagnostic function with raw data inspection
        async function runDiagnosticCheck() {
            console.log('üîç RUNNING ENHANCED DIAGNOSTIC CHECK...');
            const diagnosticDiv = document.getElementById('diagnostic-results');
            const diagnosticContent = document.getElementById('diagnostic-content');
            
            diagnosticDiv.style.display = 'block';
            diagnosticContent.innerHTML = '<p>üîÑ Running comprehensive diagnostic check...</p>';
            
            let diagnosticHTML = '<h6>üìä Feed Analysis Results:</h6>';
            
            // Check each feed individually
            for (const [propertyKey, property] of Object.entries(PROPERTY_ICAL_FEEDS)) {
                diagnosticHTML += `<h6 style="margin-top: 15px; color: #495057;">üè† ${property.name}</h6>`;
                
                for (const [platform, feedUrl] of Object.entries(property.feeds)) {
                    try {
                        console.log(`üîç DIAGNOSTIC: Checking ${platform} for ${propertyKey}`);
                        
                        const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(feedUrl);
                        const response = await fetch(proxyUrl);
                        const jsonData = await response.json();
                        let icalData = jsonData.contents || '';
                        
                        // Process data same way as main function
                        let processedData = icalData;
                        if (icalData.startsWith('data:text/calendar;base64,') || 
                            icalData.startsWith('data:text/calendar;charset=UTF-8;base64,') ||
                            icalData.startsWith('data:text/calendar;charset=utf-8;base64,')) {
                            
                            const base64Content = icalData.split('base64,')[1];
                            if (base64Content) {
                                try {
                                    processedData = atob(base64Content);
                                } catch (e) {
                                    console.error(`Base64 decode error for ${platform}:`, e);
                                }
                            }
                        }
                        
                        const hasValidCalendar = processedData && (
                            processedData.includes('BEGIN:VCALENDAR') || 
                            processedData.includes('VEVENT') ||
                            processedData.includes('DTSTART') ||
                            processedData.includes('DTEND')
                        );
                        
                        let eventCount = 0;
                        let currentBookings = 0;
                        let upcomingBookings = 0;
                        
                        if (hasValidCalendar) {
                            const events = parseICalData(processedData, platform);
                            eventCount = events.length;
                            
                            const today = new Date();
                            let pastBookings = 0;
                            events.forEach(event => {
                                const startDate = new Date(event.start);
                                const endDate = new Date(event.end);
                                
                                if (startDate <= today && endDate >= today) {
                                    currentBookings++;
                                } else if (startDate > today) {
                                    upcomingBookings++;
                                } else if (endDate < today) {
                                    pastBookings++;
                                }
                            });
                            
                            // Store historical data info for analysis
                            if (pastBookings > 0) {
                                console.log(`üìú ${platform} for ${propertyKey}: Found ${pastBookings} historical bookings!`);
                            }
                        }
                        
                        const statusColor = eventCount > 0 ? '#28a745' : (hasValidCalendar ? '#ffc107' : '#dc3545');
                        const statusIcon = eventCount > 0 ? '‚úÖ' : (hasValidCalendar ? '‚ö†Ô∏è' : '‚ùå');
                        
                        diagnosticHTML += `
                            <div style="background: white; border-left: 4px solid ${statusColor}; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>${statusIcon} ${platform.toUpperCase()}</strong><br>
                                <small>
                                    Response: ${response.status} | 
                                    Data Length: ${icalData.length} | 
                                    Valid Calendar: ${hasValidCalendar ? 'Yes' : 'No'}<br>
                                    Events Found: ${eventCount} | 
                                    Current: ${currentBookings} | 
                                    Upcoming: ${upcomingBookings}
                                </small>
                                ${eventCount === 0 && hasValidCalendar ? '<br><span style="color: #ffc107;">‚ö†Ô∏è Calendar valid but no events parsed</span>' : ''}
                                ${!hasValidCalendar ? '<br><span style="color: #dc3545;">‚ùå No valid calendar data found</span>' : ''}
                            </div>
                        `;
                        
                        // Special detailed analysis for problematic feeds
                        if ((propertyKey === 'tvhouse' && platform === 'airbnb') || 
                            (propertyKey === 'speranta' && (platform === 'airbnb' || platform === 'fewo')) ||
                            (!hasValidCalendar && icalData.length > 100)) {
                            
                            console.log(`üéØ DETAILED ANALYSIS: ${propertyKey} ${platform}`);
                            console.log(`üìÑ Raw data preview (first 800 chars): ${icalData.substring(0, 800)}`);
                            console.log(`üìÑ Processed data preview (first 800 chars): ${processedData.substring(0, 800)}`);
                            console.log(`ÔøΩ Data analysis: Has HTML tags: ${processedData.includes('<html>')} | Has error messages: ${processedData.toLowerCase().includes('error')} | Has calendar: ${processedData.includes('CALENDAR')}`);
                            
                            // Show raw data in diagnostic for problematic feeds
                            const rawPreview = processedData.substring(0, 800).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            
                            diagnosticHTML += `
                                <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ffeaa7;">
                                    <strong>üîç ${propertyKey.toUpperCase()} ${platform.toUpperCase()} Detailed Analysis:</strong><br>
                                    <small>
                                        Feed URL Status: ${response.status === 200 ? 'Accessible' : 'Error'}<br>
                                        Data Type: ${icalData.includes('<html>') ? 'HTML Page' : (icalData.includes('CALENDAR') ? 'iCal Data' : 'Unknown')}<br>
                                        Contains HTML: ${processedData.includes('<html>') ? 'Yes (Error Page)' : 'No'}<br>
                                        Contains Calendar Markers: VCALENDAR=${processedData.includes('BEGIN:VCALENDAR')}, VEVENT=${processedData.includes('BEGIN:VEVENT')}<br>
                                        <details style="margin-top: 10px;" open>
                                            <summary style="cursor: pointer; color: #007bff;">üìÑ View Raw Data (First 800 chars)</summary>
                                            <pre style="background: #f8f9fa; padding: 10px; margin-top: 10px; font-size: 11px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #dee2e6;">${rawPreview}</pre>
                                        </details>
                                    </small>
                                </div>
                            `;
                        }
                        
                    } catch (error) {
                        console.error(`üí• DIAGNOSTIC ERROR for ${platform}:`, error);
                        
                        // Enhanced error analysis for different types of failures
                        let errorAnalysis = '';
                        if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            errorAnalysis = 'Network/CORS issue - Feed URL may be blocked or invalid';
                        } else if (error.message.includes('CORS')) {
                            errorAnalysis = 'CORS policy blocking access to feed';
                        } else if (error.message.includes('404')) {
                            errorAnalysis = 'Feed URL not found - may need updating';
                        } else if (error.message.includes('timeout')) {
                            errorAnalysis = 'Feed server timeout - try again later';
                        } else {
                            errorAnalysis = 'Unknown network error';
                        }
                        
                        diagnosticHTML += `
                            <div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>‚ùå ${platform.toUpperCase()}</strong><br>
                                <small style="color: #721c24;">
                                    Error: ${error.message}<br>
                                    Analysis: ${errorAnalysis}<br>
                                    ${(propertyKey === 'tvhouse' && platform === 'airbnb') ? 
                                        '<strong>üéØ Critical: This is your missing current booking feed!</strong>' : ''
                                    }
                                </small>
                            </div>
                        `;
                        
                        // Special handling for TV House Airbnb
                        if (propertyKey === 'tvhouse' && platform === 'airbnb') {
                            console.log('üö® CRITICAL: TV House Airbnb feed fetch failed - this explains missing current booking');
                            diagnosticHTML += `
                                <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ffeaa7;">
                                    <strong>üéØ TV HOUSE AIRBNB FEED ANALYSIS:</strong><br>
                                    <small>
                                        <strong>Issue:</strong> Network fetch failure preventing access to current booking data<br>
                                        <strong>Impact:</strong> Your Oct 15-19 booking won't appear until this is resolved<br>
                                        <strong>Possible Causes:</strong><br>
                                        ‚Ä¢ Feed URL changed or expired (need new export link from Airbnb)<br>
                                        ‚Ä¢ Airbnb API temporary downtime<br>
                                        ‚Ä¢ CORS proxy limitation<br>
                                        ‚Ä¢ Calendar privacy settings changed<br>
                                        <strong>üîß Solutions to try:</strong><br>
                                        1. Generate fresh iCal export URL from Airbnb calendar settings<br>
                                        2. Check calendar privacy/sharing settings<br>
                                        3. Try alternative CORS proxy<br>
                                        4. Manual booking entry as fallback
                                    </small>
                                </div>
                            `;
                        }
                    }
                }
            }
            
            diagnosticHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #d1ecf1; border-radius: 4px;">
                    <strong>ÔøΩ Issue Analysis & Next Steps:</strong><br>
                    <small>
                        ‚úÖ Working Feeds: Speranta Booking.com (2), Speranta LekkeSlaap (4), TV House Booking.com (4)<br>
                        ‚ùå Non-Working Feeds: Speranta Airbnb, Speranta FeWo, TV House Airbnb<br>
                        üéØ <strong>Critical Issue:</strong> TV House Airbnb missing current booking (Oct 15-19)<br>
                        ÔøΩ <strong>Likely Causes:</strong> HTML error page returned instead of iCal data, feed authentication issues, or feed URL changes<br>
                        üîß <strong>Fix Strategy:</strong> Check raw data, verify feed URLs, implement HTML detection and alternative parsing<br><br>
                        üìä <strong>Historical Data Limitation:</strong> Most platforms (Airbnb, Booking.com, FeWo) filter out past bookings from iCal feeds.<br>
                        LekkeSlaap appears to be the exception, often including historical data. Consider implementing:<br>
                        ‚Ä¢ Local booking data persistence for historical records<br>
                        ‚Ä¢ Manual import functionality for past bookings<br>
                        ‚Ä¢ Database integration to store complete booking history
                    </small>
                </div>
            `;
            
            diagnosticContent.innerHTML = diagnosticHTML;
        }

        function fillAdminCredentials() {
            document.getElementById('email').value = 'sn_apt_management@outlook.com';
            document.getElementById('password').value = 'Sevilla2015!';
        }

        function fillNinaCredentials() {
            document.getElementById('email').value = 'vanwyk.nina@gmail.com';
            document.getElementById('password').value = 'HelloWorld1!';
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const users = {
                'sn_apt_management@outlook.com': {
                    password: 'Sevilla2015!',
                    name: 'Nicole and Silja',
                    role: 'admin'
                },
                'vanwyk.nina@gmail.com': {
                    password: 'HelloWorld1!',
                    name: 'Nina Williams',
                    role: 'property-manager'
                }
            };
            
            const user = users[email];
            if (!user || user.password !== password) {
                alert('Invalid email or password. Please try again.');
                return;
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('quickDashboard').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'block';
            
            // Auto-load real booking data after login
            setTimeout(() => {
                console.log('üéØ Triggering real data load after login...');
                fetchRealBookingData();
            }, 1000);
        }

        function showTab(tabName) {
            // Hide all tabs
            var tabs = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Hide all nav tabs
            var navTabs = document.getElementsByClassName('nav-tab');
            for (var i = 0; i < navTabs.length; i++) {
                navTabs[i].classList.remove('active');
            }
            
            // Show selected tab
            var selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Mark active nav tab
            var navButtons = document.querySelectorAll('[onclick*="' + tabName + '"]');
            for (var i = 0; i < navButtons.length; i++) {
                if (navButtons[i].getAttribute('onclick').includes('showTab')) {
                    navButtons[i].classList.add('active');
                    break;
                }
            }
        }

        function openAddArticleModal() {
            alert('Add Article Modal would open here.');
        }

        function filterCategory(category) {
            alert('Filtering by category: ' + category);
        }

        function editArticle(id) {
            alert('Editing article: ' + id);
        }

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Nyx Property Management System initialized');
            console.log('‚úÖ Enhanced debugging system ready');
            console.log('üìã iCal feeds configured and ready');
            
            // Load historical data on startup
            loadHistoricalData();
            
            // Auto-load booking data
            fetchRealBookingData();
        });
    </script>
</body>
</html>
