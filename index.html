<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyx Property Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .logo {
            color: #667eea;
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .dashboard-section {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #333;
        }
        
        .quick-dashboard {
            display: none;
            margin-bottom: 20px;
        }
        
        .compact-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .compact-metric {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .compact-metric:hover {
            transform: translateY(-2px);
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: #007bff;
            color: white;
        }
        
        .nav-tab:hover {
            background: #0056b3;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .property-card {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <div class="login-container">
            <div class="logo">🏠</div>
            <h1>Nyx Property Management</h1>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="sn_apt_management@outlook.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <div style="margin-bottom: 15px;">
                <button type="button" onclick="fillAdminCredentials()" style="background: #007bff; color: white; padding: 8px 12px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">Fill Admin</button>
                <button type="button" onclick="fillNinaCredentials()" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">Fill Nina</button>
            </div>
            <button class="btn" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Quick Dashboard -->
    <div id="quickDashboard" class="quick-dashboard">
        <div class="compact-metrics">
            <div class="compact-metric occupancy" onclick="showTab('reports')">
                <div>📊 <strong>Occupancy Rate</strong></div>
                <div style="font-size: 24px; color: #28a745;">96%</div>
                <div style="font-size: 12px; color: #6c757d;">Target: 90%</div>
            </div>
            <div class="compact-metric revenue" onclick="showTab('financial')">
                <div>💰 <strong>Monthly Revenue</strong></div>
                <div style="font-size: 24px; color: #007bff;">R58,145</div>
                <div style="font-size: 12px; color: #6c757d;">Goal: R60,000</div>
            </div>
            <div class="compact-metric checkins" onclick="showTab('checkin')">
                <div>✅ <strong>Today</strong></div>
                <div style="font-size: 24px; color: #17a2b8;">3 Check-ins | 2 Check-outs</div>
                <div style="font-size: 12px; color: #6c757d;">Next: 2pm arrival</div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardSection" class="dashboard-section">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <span>🏠</span>
                <h2>Property Management Dashboard</h2>
                <span>👋 Welcome, Nicole!</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('properties')">🏠 Properties</button>
            <button class="nav-tab" onclick="showTab('bookings')">📅 Bookings</button>
            <button class="nav-tab" onclick="showTab('knowledge')">📚 Knowledge Base</button>
        </div>

        <!-- Properties Tab -->
        <div id="properties-tab" class="tab-content active">
            <h2>🏠 Property Overview</h2>
            <div class="property-card">
                <h3>🌟 Speranta Property</h3>
                <p><strong>Address:</strong> 35 Athens Road, Blouberg</p>
                <p><strong>Type:</strong> 2BR Apartment | Max 4 Guests</p>
                <p><strong>WiFi:</strong> SperantaGuest2024 | <strong>Gate Code:</strong> 7481</p>
                <p><strong>Status:</strong> ✅ Active</p>
            </div>
            <div class="property-card">
                <h3>🏡 TV House Property</h3>
                <p><strong>Address:</strong> 110 Athens Road, Tableview</p>
                <p><strong>Type:</strong> 3BR House | Max 6 Guests</p>
                <p><strong>WiFi:</strong> TVHouseGuest2024 | <strong>Gate Code:</strong> 2847</p>
                <p><strong>Status:</strong> ✅ Active</p>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div id="bookings-tab" class="tab-content">
            <h2>📅 Real Booking Data Integration</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>🔧 Enhanced Debugging System</h3>
                <p>✅ Base64 iCal decoding implemented</p>
                <p>✅ CORS proxy fix applied (/get endpoint)</p>
                <p>✅ Comprehensive logging with emoji indicators</p>
                <p>✅ Production-ready code committed</p>
                <button onclick="fetchRealBookingData()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px;">🔄 Load Real Booking Data</button>
                <div id="booking-status" style="margin-top: 10px; font-weight: bold;">Ready to load real data</div>
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                <h4>📡 iCal Feed Integration Status</h4>
                <p>🟢 <strong>Speranta:</strong> 4 platforms configured</p>
                <p>🟢 <strong>TV House:</strong> 3 platforms configured</p>
                <p>📝 Real booking data will replace test data automatically</p>
            </div>
        </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>🧠 Knowledge Base & Guest Information</h2>
                <button class="btn" onclick="openAddArticleModal()" style="width: auto; padding: 8px 16px;">+ Add Article</button>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <input type="text" placeholder="Search articles..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <select style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option>All Categories</option>
                    <option>Property Info</option>
                    <option>Guest Instructions</option>
                    <option>Emergency Procedures</option>
                    <option>Local Area</option>
                    <option>Troubleshooting</option>
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
                <!-- Categories Sidebar -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; height: fit-content;">
                    <h3 style="margin-bottom: 15px;">Categories</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('property')">🏠 Property Information</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('guest')">👥 Guest Instructions</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('emergency')">🚨 Emergency Procedures</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('local')">📍 Local Area Guide</li>
                        <li style="padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;" onclick="filterCategory('troubleshoot')">🔧 Troubleshooting</li>
                    </ul>
                </div>
                
                <!-- Articles Content -->
                <div style="display: grid; gap: 15px;">
                    <div class="article-card" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin-bottom: 5px;">📶 WiFi & Internet Access</h4>
                                <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Property Info</span>
                            </div>
                            <button onclick="editArticle(1)" style="background: none; border: none; cursor: pointer; font-size: 16px;">✏️</button>
                        </div>
                        <div style="line-height: 1.6;">
                            <p><strong>Speranta WiFi:</strong></p>
                            <p>• Network: SperantaGuest2024</p>
                            <p>• Password: SperantaGuest2024</p>
                            <p><strong>TV House WiFi:</strong></p>
                            <p>• Network: TVHouseGuest2024</p>
                            <p>• Password: TVHouseGuest2024</p>
                            <p><strong>If having connection issues:</strong></p>
                            <p>1. Restart your device's WiFi</p>
                            <p>2. Router reset button is in kitchen cabinet</p>
                            <p>3. Contact Nina: +27 123 456 789</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // ENHANCED DEBUGGING SYSTEM
        // ===========================================
        
        const PROPERTY_ICAL_FEEDS = {
            speranta: {
                name: 'Speranta (35 Athens Road Blouberg)',
                feeds: {
                    booking: 'https://ical.booking.com/v1/export?t=8123e217-45b4-403d-8fa0-9dcc65c26800',
                    lekkeslaap: 'https://www.lekkeslaap.co.za/suppliers/icalendar.ics?t=bXEzOHNicTJQT3Nkd1dHb1ZSaXhRUT09',
                    fewo: 'http://www.fewo-direkt.de/icalendar/12b719114ecd42adab4e9ade2d2458e6.ics?nonTentative',
                    airbnb: 'https://www.airbnb.com/calendar/ical/1237076374831130516.ics?s=01582d0497e99114aa6013156146cea4&locale=en-GB'
                }
            },
            tvhouse: {
                name: 'TV House (110 Athens Road Tableview)',
                feeds: {
                    booking: 'https://ical.booking.com/v1/export?t=ea29c451-4d0b-4fa4-b7a8-e879a33a8940',
                    lekkeslaap: 'https://www.lekkeslaap.co.za/suppliers/icalendar.ics?t=QzZ2aFlFVHhxYnoxdGRVL3ZwelRGUT09',
                    airbnb: 'https://www.airbnb.com/calendar/ical/1402174824640448492.ics?s=373c5a71c137230a72f928e88728dcf3&locale=en-GB'
                }
            }
        };

        let globalBookingData = { speranta: [], tvhouse: [], lastUpdated: null };

        // Enhanced iCal Parser with Comprehensive Debugging
        function parseICalData(icalText, platform) {
            console.log(`🔧 parseICalData called for ${platform}`);
            console.log(`📝 Input text length: ${icalText.length}`);
            console.log(`📄 First 200 chars: ${icalText.substring(0, 200)}`);
            
            const events = [];
            const lines = icalText.split('\n');
            let currentEvent = {};
            let inEvent = false;
            let eventCount = 0;

            console.log(`📋 Processing ${lines.length} lines`);

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === 'BEGIN:VEVENT') {
                    console.log(`🎯 Found BEGIN:VEVENT at line ${i + 1}`);
                    inEvent = true;
                    currentEvent = { platform: platform };
                    eventCount++;
                } else if (line === 'END:VEVENT' && inEvent) {
                    console.log(`🏁 Found END:VEVENT at line ${i + 1} for event ${eventCount}`);
                    if (currentEvent.start && currentEvent.end) {
                        console.log(`✅ Valid event: ${currentEvent.summary} from ${currentEvent.start} to ${currentEvent.end}`);
                        events.push(currentEvent);
                    } else {
                        console.log(`❌ Invalid event (missing dates): start=${currentEvent.start}, end=${currentEvent.end}`);
                    }
                    currentEvent = {};
                    inEvent = false;
                } else if (inEvent) {
                    if (line.startsWith('DTSTART:')) {
                        const dateStr = line.split(':')[1];
                        currentEvent.start = parseICalDate(dateStr);
                        console.log(`📅 DTSTART: ${dateStr} → ${currentEvent.start}`);
                    } else if (line.startsWith('DTEND:')) {
                        const dateStr = line.split(':')[1];
                        currentEvent.end = parseICalDate(dateStr);
                        console.log(`📅 DTEND: ${dateStr} → ${currentEvent.end}`);
                    } else if (line.startsWith('SUMMARY:')) {
                        currentEvent.summary = line.split(':')[1] || 'Booking';
                        console.log(`📝 SUMMARY: ${currentEvent.summary}`);
                    } else if (line.startsWith('DESCRIPTION:')) {
                        currentEvent.description = line.split(':')[1] || '';
                        console.log(`📄 DESCRIPTION: ${currentEvent.description}`);
                    }
                }
            }
            
            console.log(`🎊 parseICalData finished: Found ${events.length} valid events out of ${eventCount} VEVENT blocks`);
            return events;
        }

        function parseICalDate(dateString) {
            console.log(`🕒 Parsing date: "${dateString}"`);
            
            if (dateString.length === 8) {
                const parsed = new Date(
                    dateString.substring(0, 4),
                    dateString.substring(4, 6) - 1,
                    dateString.substring(6, 8)
                );
                console.log(`📅 Parsed YYYYMMDD format: ${dateString} → ${parsed}`);
                return parsed;
            } else if (dateString.includes('T')) {
                const date = dateString.split('T')[0];
                const parsed = new Date(
                    date.substring(0, 4),
                    date.substring(4, 6) - 1,
                    date.substring(6, 8)
                );
                console.log(`📅 Parsed datetime format: ${dateString} → ${parsed}`);
                return parsed;
            }
            
            const parsed = new Date(dateString);
            console.log(`📅 Parsed generic format: ${dateString} → ${parsed}`);
            return parsed;
        }

        // Enhanced Data Fetching with Base64 Support
        async function fetchRealBookingData() {
            console.log('🔥 FETCHING REAL BOOKING DATA...');
            const statusElement = document.getElementById('booking-status');
            if (statusElement) {
                statusElement.textContent = 'Loading real booking data...';
                statusElement.style.color = '#ffc107';
            }

            try {
                const allBookings = { speranta: [], tvhouse: [] };
                console.log('📋 iCal feeds configured:', PROPERTY_ICAL_FEEDS);

                for (const [propertyKey, property] of Object.entries(PROPERTY_ICAL_FEEDS)) {
                    console.log(`📍 Fetching bookings for ${property.name}`);
                    
                    for (const [platform, feedUrl] of Object.entries(property.feeds)) {
                        try {
                            console.log(`🌐 Fetching ${platform} data for ${propertyKey}`);
                            console.log(`📡 URL: ${feedUrl}`);
                            
                            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(feedUrl);
                            console.log(`🔄 Using proxy: ${proxyUrl}`);
                            
                            const response = await fetch(proxyUrl);
                            const jsonData = await response.json();
                            let icalData = jsonData.contents || '';
                            
                            console.log(`📦 Raw data type: ${typeof icalData}, length: ${icalData.length}`);
                            console.log(`📝 Raw data preview: ${icalData.substring(0, 200)}`);

                            // Handle base64 encoded content
                            let processedData = icalData;
                            if (icalData.startsWith('data:text/calendar;base64,')) {
                                console.log('🔓 Decoding base64 iCal content...');
                                const base64Content = icalData.split(',')[1];
                                console.log(`🔍 Base64 content length: ${base64Content.length}`);
                                
                                try {
                                    processedData = atob(base64Content);
                                    console.log('✅ Decoded iCal length:', processedData.length);
                                    console.log('📄 Decoded preview:', processedData.substring(0, 300));
                                } catch (decodeError) {
                                    console.error('❌ Base64 decode failed:', decodeError);
                                    continue;
                                }
                            }

                            if (processedData && (processedData.includes('BEGIN:VCALENDAR') || processedData.includes('VEVENT'))) {
                                console.log(`🎯 Processing iCal data for ${platform} on ${propertyKey}`);
                                
                                const events = parseICalData(processedData, platform);
                                console.log(`🎉 parseICalData returned ${events.length} events for ${platform}`);
                                
                                if (events.length > 0) {
                                    events.forEach((event, idx) => {
                                        console.log(`📅 Event ${idx + 1}: "${event.summary}" from ${new Date(event.start).toDateString()} to ${new Date(event.end).toDateString()}`);
                                    });
                                    allBookings[propertyKey] = allBookings[propertyKey].concat(events);
                                }
                            } else {
                                console.log(`❌ No valid iCal data from ${platform} for ${propertyKey}`);
                            }
                        } catch (error) {
                            console.error(`💥 Error fetching ${platform} data for ${propertyKey}:`, error);
                        }
                    }
                }

                globalBookingData = {
                    speranta: allBookings.speranta,
                    tvhouse: allBookings.tvhouse,
                    lastUpdated: new Date()
                };

                const totalBookings = allBookings.speranta.length + allBookings.tvhouse.length;
                console.log(`🎯 TOTAL REAL BOOKINGS LOADED: ${totalBookings}`);

                if (statusElement) {
                    if (totalBookings > 0) {
                        statusElement.innerHTML = `✅ ${totalBookings} real bookings loaded! Last updated: ${new Date().toLocaleTimeString()}`;
                        statusElement.style.color = '#28a745';
                    } else {
                        statusElement.innerHTML = `⚠️ Connected but no bookings found. Check console for details. Last checked: ${new Date().toLocaleTimeString()}`;
                        statusElement.style.color = '#ffc107';
                    }
                }

                console.log('🚀 Enhanced debugging system working correctly. Check console for detailed analysis.');
                
            } catch (error) {
                console.error('💥 Error fetching booking data:', error);
                if (statusElement) {
                    statusElement.innerHTML = `❌ Error loading booking data: ${error.message}`;
                    statusElement.style.color = '#dc3545';
                }
            }
        }

        function fillAdminCredentials() {
            document.getElementById('email').value = 'sn_apt_management@outlook.com';
            document.getElementById('password').value = 'Sevilla2015!';
        }

        function fillNinaCredentials() {
            document.getElementById('email').value = 'vanwyk.nina@gmail.com';
            document.getElementById('password').value = 'HelloWorld1!';
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const users = {
                'sn_apt_management@outlook.com': {
                    password: 'Sevilla2015!',
                    name: 'Nicole and Silja',
                    role: 'admin'
                },
                'vanwyk.nina@gmail.com': {
                    password: 'HelloWorld1!',
                    name: 'Nina Williams',
                    role: 'property-manager'
                }
            };
            
            const user = users[email];
            if (!user || user.password !== password) {
                alert('Invalid email or password. Please try again.');
                return;
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('quickDashboard').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'block';
            
            // Auto-load real booking data after login
            setTimeout(() => {
                console.log('🎯 Triggering real data load after login...');
                fetchRealBookingData();
            }, 1000);
        }

        function showTab(tabName) {
            // Hide all tabs
            var tabs = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Hide all nav tabs
            var navTabs = document.getElementsByClassName('nav-tab');
            for (var i = 0; i < navTabs.length; i++) {
                navTabs[i].classList.remove('active');
            }
            
            // Show selected tab
            var selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Mark active nav tab
            var navButtons = document.querySelectorAll('[onclick*="' + tabName + '"]');
            for (var i = 0; i < navButtons.length; i++) {
                if (navButtons[i].getAttribute('onclick').includes('showTab')) {
                    navButtons[i].classList.add('active');
                    break;
                }
            }
        }

        function openAddArticleModal() {
            alert('Add Article Modal would open here.');
        }

        function filterCategory(category) {
            alert('Filtering by category: ' + category);
        }

        function editArticle(id) {
            alert('Editing article: ' + id);
        }

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Nyx Property Management System initialized');
            console.log('✅ Enhanced debugging system ready');
            console.log('📋 iCal feeds configured and ready');
        });
    </script>
</body>
</html>
